!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).cql={})}(this,(function(e){"use strict";Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function e(){var t=isNaN(arguments[0])?1:Number(arguments[0]);return t?Array.prototype.reduce.call(this,(function(n,r){return Array.isArray(r)?n.push.apply(n,e.call(r,t-1)):n.push(r),n}),[]):Array.prototype.slice.call(this)},writable:!0}),Array.prototype.flatMap||Object.defineProperty(Array.prototype,"flatMap",{configurable:!0,value:function(e){return Array.prototype.map.apply(this,arguments).flat()},writable:!0});"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;!function(e){var t=function(){function e(e,t){return null!=t&&e instanceof t}var t,n,r;try{t=Map}catch(e){t=function(){}}try{n=Set}catch(e){n=function(){}}try{r=Promise}catch(e){r=function(){}}function i(o,s,c,u,l){"object"==typeof s&&(c=s.depth,u=s.prototype,l=s.includeNonEnumerable,s=s.circular);var d=[],f=[],p="undefined"!=typeof Buffer;return void 0===s&&(s=!0),void 0===c&&(c=1/0),function o(c,g){if(null===c)return null;if(0===g)return c;var h,m;if("object"!=typeof c)return c;if(e(c,t))h=new t;else if(e(c,n))h=new n;else if(e(c,r))h=new r((function(e,t){c.then((function(t){e(o(t,g-1))}),(function(e){t(o(e,g-1))}))}));else if(i.__isArray(c))h=[];else if(i.__isRegExp(c))h=new RegExp(c.source,a(c)),c.lastIndex&&(h.lastIndex=c.lastIndex);else if(i.__isDate(c))h=new Date(c.getTime());else{if(p&&Buffer.isBuffer(c))return h=Buffer.allocUnsafe?Buffer.allocUnsafe(c.length):new Buffer(c.length),c.copy(h),h;e(c,Error)?h=Object.create(c):void 0===u?(m=Object.getPrototypeOf(c),h=Object.create(m)):(h=Object.create(u),m=u)}if(s){var y=d.indexOf(c);if(-1!=y)return f[y];d.push(c),f.push(h)}for(var v in e(c,t)&&c.forEach((function(e,t){var n=o(t,g-1),r=o(e,g-1);h.set(n,r)})),e(c,n)&&c.forEach((function(e){var t=o(e,g-1);h.add(t)})),c){var b;m&&(b=Object.getOwnPropertyDescriptor(m,v)),b&&null==b.set||(h[v]=o(c[v],g-1))}if(Object.getOwnPropertySymbols){var E=Object.getOwnPropertySymbols(c);for(v=0;v<E.length;v++){var T=E[v];(!(x=Object.getOwnPropertyDescriptor(c,T))||x.enumerable||l)&&(h[T]=o(c[T],g-1),x.enumerable||Object.defineProperty(h,T,{enumerable:!1}))}}if(l){var w=Object.getOwnPropertyNames(c);for(v=0;v<w.length;v++){var x,C=w[v];(x=Object.getOwnPropertyDescriptor(c,C))&&x.enumerable||(h[C]=o(c[C],g-1),Object.defineProperty(h,C,{enumerable:!1}))}}return h}(o,c)}function o(e){return Object.prototype.toString.call(e)}function a(e){var t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),t}return i.clonePrototype=function(e){if(null===e)return null;var t=function(){};return t.prototype=e,new t},i.__objToStr=o,i.__isDate=function(e){return"object"==typeof e&&"[object Date]"===o(e)},i.__isArray=function(e){return"object"==typeof e&&"[object Array]"===o(e)},i.__isRegExp=function(e){return"object"==typeof e&&"[object RegExp]"===o(e)},i.__getRegExpFlags=a,i}();e.exports&&(e.exports=t)}({exports:{}});function t(e,t,n){return e.fields=t||[],e.fname=n,e}function n(e){return 1===e.length?r(e[0]):i(e)}const r=e=>function(t){return t[e]},i=e=>{const t=e.length;return function(n){for(let r=0;r<t;++r)n=n[e[r]];return n}};function o(e){throw Error(e)}function a(e){const t=[],n=e.length;let r,i,a,s=null,c=0,u="";function l(){t.push(u+e.substring(r,i)),u="",r=i+1}for(e+="",r=i=0;i<n;++i)if(a=e[i],"\\"===a)u+=e.substring(r,i),u+=e.substring(++i,++i),r=i;else if(a===s)l(),s=null,c=-1;else{if(s)continue;r===c&&'"'===a||r===c&&"'"===a?(r=i+1,s=a):"."!==a||c?"["===a?(i>r&&l(),c=r=i+1):"]"===a&&(c||o("Access path missing open bracket: "+e),c>0&&l(),c=0,r=i+1):i>r?l():r=i+1}return c&&o("Access path missing closing bracket: "+e),s&&o("Access path missing closing quote: "+e),i>r&&(i++,l()),t}function s(e,t,n){const r=[t].concat([].slice.call(n));console[e].apply(console,r)}!function(e,r,i){const o=a(e);e=1===o.length?o[0]:e,t((i&&i.get||n)(o),[e],r||e)}("id"),t((e=>e),[],"identity"),t((()=>0),[],"zero"),t((()=>1),[],"one"),t((()=>!0),[],"true"),t((()=>!1),[],"false");var c=Array.isArray;function u(e){return e===Object(e)}function l(e){return"boolean"==typeof e}function d(e){return"string"==typeof e}function f(e){return c(e)?"["+e.map(f)+"]":u(e)||d(e)?JSON.stringify(e).replace("\u2028","\\u2028").replace("\u2029","\\u2029"):e}function p(e){const t={},n=e.length;for(let r=0;r<n;++r)t[e[r]]=!0;return t}function g(e,t){return e.indexOf(t)>-1}function h(e,t){let n=0;for(const[r,i]of e.entries())if(t(i,r,n++))return!0;return!1}Set.prototype.toJSON=function(){return`Set(${[...this].map((e=>function(e,t){t||(t={}),"function"==typeof t&&(t={cmp:t});var n,r="boolean"==typeof t.cycles&&t.cycles,i=t.cmp&&(n=t.cmp,function(e){return function(t,r){var i={key:t,value:e[t]},o={key:r,value:e[r]};return n(i,o)}}),o=[];return function e(t){if(t&&t.toJSON&&"function"==typeof t.toJSON&&(t=t.toJSON()),void 0!==t){if("number"==typeof t)return isFinite(t)?""+t:"null";if("object"!=typeof t)return JSON.stringify(t);var n,a;if(Array.isArray(t)){for(a="[",n=0;n<t.length;n++)n&&(a+=","),a+=e(t[n])||"null";return a+"]"}if(null===t)return"null";if(-1!==o.indexOf(t)){if(r)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}var s=o.push(t)-1,c=Object.keys(t).sort(i&&i(t));for(a="",n=0;n<c.length;n++){var u=c[n],l=e(t[u]);l&&(a&&(a+=","),a+=JSON.stringify(u)+":"+l)}return o.splice(s,1),"{"+a+"}"}}(e)}(e))).join(",")})`};const m=Object.keys,y=Object.entries;function v(e){const t=e.replace(/\W/g,"_");return(e.match(/^\d+/)?"_":"")+t}function b(e){return e.replace(/(\[|\]|\.|'|")/g,"\\$1")}var E=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n};const T="row",w="column",x="facet",C="x",O="y",A="x2",S="y2",N="radius",M="radius2",_="theta",F="theta2",k="latitude",U="longitude",P="latitude2",I="longitude2",D="color",$="fill",j="stroke",R="shape",B="size",L="angle",G="opacity",z="fillOpacity",W="strokeOpacity",H="strokeWidth",q="strokeDash",Y="text",Q="order",V="detail",K="key",J="tooltip",X="href",Z="url",ee="description",te=Object.assign(Object.assign(Object.assign(Object.assign({},{x:1,y:1,x2:1,y2:1}),{theta:1,theta2:1,radius:1,radius2:1}),{longitude:1,longitude2:1,latitude:1,latitude2:1}),{color:1,fill:1,stroke:1,opacity:1,fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeDash:1,size:1,angle:1,shape:1,order:1,text:1,detail:1,key:1,tooltip:1,href:1,url:1,description:1});function ne(e){return e===D||e===$||e===j}const re=Object.assign(Object.assign({},te),{row:1,column:1,facet:1}),ie=m(re),oe=E(re,["order","detail","tooltip"]);E(oe,["row","column","facet"]);const ae=E(te,["x","y","x2","y2","latitude","longitude","latitude2","longitude2","theta","theta2","radius","radius2"]),se=m(ae),ce={x:1,y:1},ue={theta:1,radius:1},le=E(ae,["text","tooltip","href","url","description","detail","key","order"]),de=Object.assign(Object.assign(Object.assign({},ce),ue),le);function fe(e){return!!de[e]}function pe(e,t){return function(e){switch(e){case D:case $:case j:case ee:case V:case K:case J:case X:case Q:case G:case z:case W:case H:case x:case T:case w:return ge;case C:case O:case k:case U:return he;case A:case S:case P:case I:return{area:"always",bar:"always",image:"always",rect:"always",rule:"always",circle:"binned",point:"binned",square:"binned",tick:"binned",line:"binned",trail:"binned"};case B:return{point:"always",tick:"always",rule:"always",circle:"always",square:"always",bar:"always",text:"always",line:"always",trail:"always"};case q:return{line:"always",point:"always",tick:"always",rule:"always",circle:"always",square:"always",bar:"always",geoshape:"always"};case R:return{point:"always",geoshape:"always"};case Y:return{text:"always"};case L:return{point:"always",square:"always",text:"always"};case Z:return{image:"always"};case _:case N:return{text:"always",arc:"always"};case F:case M:return{arc:"always"}}}(e)[t]}const ge={arc:"always",area:"always",bar:"always",circle:"always",geoshape:"always",image:"always",line:"always",rule:"always",point:"always",rect:"always",square:"always",trail:"always",text:"always",tick:"always"},he=E(ge,["geoshape"]);function me(e){switch(e){case C:case O:case _:case N:case B:case L:case H:case G:case z:case W:case A:case S:case F:case M:return;case x:case T:case w:case R:case q:case Y:case J:case X:case Z:case ee:return"discrete";case D:case $:case j:return"flexible";case k:case U:case P:case I:case V:case K:case Q:return}}const ye=Object.assign(Object.assign({},{orient:1,aria:1,bandPosition:1,description:1,domain:1,domainCap:1,domainColor:1,domainDash:1,domainDashOffset:1,domainOpacity:1,domainWidth:1,format:1,formatType:1,grid:1,gridCap:1,gridColor:1,gridDash:1,gridDashOffset:1,gridOpacity:1,gridWidth:1,labelAlign:1,labelAngle:1,labelBaseline:1,labelBound:1,labelColor:1,labelFlush:1,labelFlushOffset:1,labelFont:1,labelFontSize:1,labelFontStyle:1,labelFontWeight:1,labelLimit:1,labelLineHeight:1,labelOffset:1,labelOpacity:1,labelOverlap:1,labelPadding:1,labels:1,labelSeparation:1,maxExtent:1,minExtent:1,offset:1,position:1,tickBand:1,tickCap:1,tickColor:1,tickCount:1,tickDash:1,tickDashOffset:1,tickExtra:1,tickMinStep:1,tickOffset:1,tickOpacity:1,tickRound:1,ticks:1,tickSize:1,tickWidth:1,title:1,titleAlign:1,titleAnchor:1,titleAngle:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontStyle:1,titleFontWeight:1,titleLimit:1,titleLineHeight:1,titleOpacity:1,titlePadding:1,titleX:1,titleY:1,translate:1,values:1,zindex:1}),{style:1,labelExpr:1,encoding:1}),ve=m(ye),be=m({aria:1,clipHeight:1,columnPadding:1,columns:1,cornerRadius:1,description:1,direction:1,fillColor:1,format:1,formatType:1,gradientLength:1,gradientOpacity:1,gradientStrokeColor:1,gradientStrokeWidth:1,gradientThickness:1,gridAlign:1,labelAlign:1,labelBaseline:1,labelColor:1,labelFont:1,labelFontSize:1,labelFontStyle:1,labelFontWeight:1,labelLimit:1,labelOffset:1,labelOpacity:1,labelOverlap:1,labelPadding:1,labelSeparation:1,legendX:1,legendY:1,offset:1,orient:1,padding:1,rowPadding:1,strokeColor:1,symbolDash:1,symbolDashOffset:1,symbolFillColor:1,symbolLimit:1,symbolOffset:1,symbolOpacity:1,symbolSize:1,symbolStrokeColor:1,symbolStrokeWidth:1,symbolType:1,tickCount:1,tickMinStep:1,title:1,titleAlign:1,titleAnchor:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontStyle:1,titleFontWeight:1,titleLimit:1,titleLineHeight:1,titleOpacity:1,titleOrient:1,titlePadding:1,type:1,values:1,zindex:1});function Ee(e){return`Invalid field type "${e}".`}function Te(e){return`${e} encoding should be discrete (ordinal / nominal / binned).`}function we(e,t){return`Using discrete channel "${e}" to encode "${t}" field can be misleading as it does not encode ${"ordinal"===t?"order":"magnitude"}.`}let xe=function(e,t){let n=e||0;return{level(e){return arguments.length?(n=+e,this):n},error(){return n>=1&&s(t||"error","ERROR",arguments),this},warn(){return n>=2&&s(t||"warn","WARN",arguments),this},info(){return n>=3&&s(t||"log","INFO",arguments),this},debug(){return n>=4&&s(t||"log","DEBUG",arguments),this}}}(2);function Ce(...e){xe.warn(...e)}const Oe="quantitative",Ae="ordinal",Se="temporal",Ne="nominal",Me="geojson";var _e=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n};const Fe="linear",ke="log",Ue="pow",Pe="sqrt",Ie="symlog",De="time",$e="utc",je="quantile",Re="quantize",Be="threshold",Le=["linear","log","pow","sqrt","symlog","time","utc"],Ge=p(Le);p(["linear","log","pow","sqrt","symlog"]);const ze=p(["quantile","quantize","threshold"]),We=p(Le.concat(["quantile","quantize","threshold","sequential","identity"])),He=p(["ordinal","bin-ordinal","point","band"]);function qe(e){return e in He}function Ye(e){return e in Ge}function Qe(e){return e in ze}const Ve={type:1,domain:1,domainMax:1,domainMin:1,domainMid:1,align:1,range:1,rangeMax:1,rangeMin:1,scheme:1,bins:1,reverse:1,round:1,clamp:1,nice:1,base:1,exponent:1,constant:1,interpolate:1,zero:1,padding:1,paddingInner:1,paddingOuter:1},Ke=m(Ve);function Je(e,t){switch(t){case"type":case"domain":case"reverse":case"range":return!0;case"scheme":case"interpolate":return!g(["point","band","identity"],e);case"bins":return!g(["point","band","identity","ordinal"],e);case"round":return Ye(e)||"band"===e||"point"===e;case"padding":case"rangeMin":case"rangeMax":return Ye(e)||g(["point","band"],e);case"paddingOuter":case"align":return g(["point","band"],e);case"paddingInner":return"band"===e;case"domainMax":case"domainMid":case"domainMin":case"clamp":return Ye(e);case"nice":return Ye(e)||"quantize"===e||"threshold"===e;case"exponent":return"pow"===e;case"base":return"log"===e;case"constant":return"symlog"===e;case"zero":return function(e){return e in We}(e)&&!g(["log","time","utc","threshold","quantile"],e)}}function Xe(e,t){switch(t){case"interpolate":case"scheme":case"domainMid":return ne(e)?void 0:`Cannot use the scale property "${e}" with non-color channel.`;case"align":case"type":case"bins":case"domain":case"domainMax":case"domainMin":case"range":case"base":case"exponent":case"constant":case"nice":case"padding":case"paddingInner":case"paddingOuter":case"rangeMax":case"rangeMin":case"reverse":case"round":case"clamp":case"zero":return}}_e(Ve,["type","domain","range","rangeMax","rangeMin","scheme"]);var Ze={exports:{}};function et(e,t){return-1!==e.indexOf(t)}function tt(e,t){for(let n=0;n<e.length;n++)if(!t(e[n],n))return!1;return!0}function nt(e,t,n){if(e.forEach)e.forEach.call(n,t);else for(const r in e)t.call(n,e[r],r,e)}function rt(e,t){let n=0;for(let r=0;r<e.length;r++)if(t(e[r],r,n++))return!0;return!1}function it(e,t){return e.filter((function(e){return!et(t,e)}))}function ot(e){return Object.keys(e)}!function(e){var t=e.exports,n="__name__";t.namedfunc=function(e,t){return t[n]=e,t},t.name=function(e){return null==e?null:e[n]},t.identity=function(e){return e},t.true=t.namedfunc("true",(function(){return!0})),t.false=t.namedfunc("false",(function(){return!1})),t.duplicate=function(e){return JSON.parse(JSON.stringify(e))},t.equal=function(e,t){return JSON.stringify(e)===JSON.stringify(t)},t.extend=function(e){for(var t,n,r=1,i=arguments.length;r<i;++r)for(n in t=arguments[r])e[n]=t[n];return e},t.length=function(e){return null!=e&&null!=e.length?e.length:null},t.keys=function(e){var t,n=[];for(t in e)n.push(t);return n},t.vals=function(e){var t,n=[];for(t in e)n.push(e[t]);return n},t.toMap=function(e,n){return(n=t.$(n))?e.reduce((function(e,t){return e[n(t)]=1,e}),{}):e.reduce((function(e,t){return e[t]=1,e}),{})},t.keystr=function(e){var t=e.length;if(!t)return"";for(var n=String(e[0]),r=1;r<t;++r)n+="|"+String(e[r]);return n};var r=Object.prototype.toString;t.isObject=function(e){return e===Object(e)},t.isFunction=function(e){return"[object Function]"===r.call(e)},t.isString=function(e){return"string"==typeof value||"[object String]"===r.call(e)},t.isArray=Array.isArray||function(e){return"[object Array]"===r.call(e)},t.isNumber=function(e){return"number"==typeof e||"[object Number]"===r.call(e)},t.isBoolean=function(e){return!0===e||!1===e||"[object Boolean]"==r.call(e)},t.isDate=function(e){return"[object Date]"===r.call(e)},t.isValid=function(e){return null!=e&&e==e},t.isBuffer="function"==typeof Buffer&&Buffer.isBuffer||t.false,t.number=function(e){return null==e||""===e?null:+e},t.boolean=function(e){return null==e||""===e?null:"false"!==e&&!!e},t.date=function(e,t){var n=t||Date;return null==e||""===e?null:n.parse(e)},t.array=function(e){return null!=e?t.isArray(e)?e:[e]:[]},t.str=function(e){return t.isArray(e)?"["+e.map(t.str)+"]":t.isObject(e)||t.isString(e)?JSON.stringify(e).replace("\u2028","\\u2028").replace("\u2029","\\u2029"):e};var i=/\[(.*?)\]|[^.\[]+/g;function o(e,t){var n,r="";for(n=0;n<e;++n)r+=t;return r}function a(e,t,n){var r=0,i=e.split(s);return(e=n?(i=i.reverse()).filter((function(e){return(r+=e.length)<=t})).reverse():i.filter((function(e){return(r+=e.length)<=t}))).length?e.join("").trim():i[0].slice(0,t)}t.field=function(e){return String(e).match(i).map((function(e){return"["!==e[0]?e:"'"!==e[1]&&'"'!==e[1]?e.slice(1,-1):e.slice(2,-2).replace(/\\(["'])/g,"$1")}))},t.accessor=function(e){return null==e||t.isFunction(e)?e:t.namedfunc(e,Function("x","return x["+t.field(e).map(t.str).join("][")+"];"))},t.$=t.accessor,t.mutator=function(e){var n;return t.isString(e)&&(n=t.field(e)).length>1?function(e,t){for(var r=0;r<n.length-1;++r)e=e[n[r]];e[n[r]]=t}:function(t,n){t[e]=n}},t.$func=function(e,n){return function(r){r=t.$(r)||t.identity;var i=e+(t.name(r)?"_"+t.name(r):"");return t.namedfunc(i,(function(e){return n(r(e))}))}},t.$valid=t.$func("valid",t.isValid),t.$length=t.$func("length",t.length),t.$in=function(e,n){e=t.$(e);var r=t.isArray(n)?t.toMap(n):n;return function(t){return!!r[e(t)]}},t.comparator=function(e){var n=[];return void 0===e&&(e=[]),e=t.array(e).map((function(e){var r=1;return"-"===e[0]?(r=-1,e=e.slice(1)):"+"===e[0]&&(r=1,e=e.slice(1)),n.push(r),t.accessor(e)})),function(r,i){var o,a,s,c;for(o=0,a=e.length;o<a;++o)if(s=e[o],c=t.cmp(s(r),s(i)))return c*n[o];return 0}},t.cmp=function(e,t){return(e<t||null==e)&&null!=t?-1:(e>t||null==t)&&null!=e?1:(t=t instanceof Date?+t:t,(e=e instanceof Date?+e:e)!==e&&t==t?-1:t!=t&&e==e?1:0)},t.numcmp=function(e,t){return e-t},t.stablesort=function(e,t,n){var r=e.reduce((function(e,t,r){return e[n(t)]=r,e}),{});return e.sort((function(e,i){var o=t(e),a=t(i);return o<a?-1:o>a?1:r[n(e)]-r[n(i)]})),e},t.permute=function(e){for(var t,n,r=e.length;r;)n=Math.floor(Math.random()*r--),t=e[r],e[r]=e[n],e[n]=t},t.pad=function(e,t,n,r){r=r||" ";var i=t-e.length;if(i<=0)return e;switch(n){case"left":return o(i,r)+e;case"middle":case"center":return o(Math.floor(i/2),r)+e+o(Math.ceil(i/2),r);default:return e+o(i,r)}},t.truncate=function(e,t,n,r,i){var o=e.length;if(o<=t)return e;i=void 0!==i?String(i):"…";var s=Math.max(0,t-i.length);switch(n){case"left":return i+(r?a(e,s,1):e.slice(o-s));case"middle":case"center":var c=Math.ceil(s/2),u=Math.floor(s/2);return(r?a(e,c):e.slice(0,c))+i+(r?a(e,u,1):e.slice(o-u));default:return(r?a(e,s):e.slice(0,s))+i}};var s=/([\u0009\u000A\u000B\u000C\u000D\u0020\u00A0\u1680\u180E\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u2028\u2029\u3000\uFEFF])/}(Ze);var at=Object.freeze({__proto__:null,isArray:Ze.exports.isArray,contains:et,every:tt,forEach:nt,some:rt,nestedMap:function e(t,n){return t.map((t=>Ze.exports.isArray(t)?e(t,n):n(t)))},without:it,flagKeys:ot,cmp:Ze.exports.cmp,keys:Ze.exports.keys,duplicate:Ze.exports.duplicate,extend:Ze.exports.extend,isObject:Ze.exports.isObject,isBoolean:Ze.exports.isBoolean,toMap:Ze.exports.toMap});function st(e){return!!e.parent}const ct={channel:1,aggregate:1,autoCount:1,bin:1,timeUnit:1,hasFn:1,sort:1,stack:1,field:1,type:1,format:1,scale:1,axis:1,legend:1,value:1},ut=ot(ct);function lt(e){return e.toString()in ct}const dt={bin:1,scale:1,sort:1,axis:1,legend:1};function ft(e){return dt[e]}const pt=["maxbins","divide","extent","base","step","steps","minstep"],gt=["field","op","order"],ht=pt.map((e=>({parent:"bin",child:e}))),mt=gt.map((e=>({parent:"sort",child:e}))),yt=Ke.map((e=>({parent:"scale",child:e}))),vt=ve.map((e=>({parent:"axis",child:e}))),bt=be.map((e=>({parent:"legend",child:e}))),Et=[].concat(ht,mt,yt,vt,bt),Tt=["width","height","background","padding","title"];function wt(e){return st(e)?e.parent+"."+e.child:e}function xt(e){const t=e.split(".");if(1===t.length)return e;if(2===t.length)return{parent:t[0],child:t[1]};throw`Invalid property key with ${t.length} dots: ${e}`}const Ct=Et.reduce(((e,t)=>(e[t.parent]=e[t.parent]||[],e[t.parent][t.child]=t,e)),{});function Ot(e,t){return(Ct[e]||{})[t]}function At(e){return lt(e)||st(e)}const St=[].concat(ut,Et),Nt=["type","field","bin","timeUnit","aggregate","autoCount","channel","mark","stack","scale","sort","axis","legend"].concat(ht,yt,vt,bt,mt);var Mt;!function(e){e.MARK="mark",e.TRANSFORM="transform",e.STACK="stack",e.FORMAT="format",e.CHANNEL="channel",e.AGGREGATE="aggregate",e.AUTOCOUNT="autoCount",e.BIN="bin",e.HAS_FN="hasFn",e.TIMEUNIT="timeUnit",e.FIELD="field",e.TYPE="type",e.SORT="sort",e.SCALE="scale",e.AXIS="axis",e.LEGEND="legend",e.WIDTH="width",e.HEIGHT="height",e.BACKGROUND="background",e.PADDING="padding",e.TITLE="title"}(Mt||(Mt={}));var _t=Object.freeze({__proto__:null,isEncodingNestedProp:st,ENCODING_TOPLEVEL_PROPS:ut,isEncodingTopLevelProperty:lt,isEncodingNestedParent:ft,BIN_CHILD_PROPS:pt,SORT_CHILD_PROPS:gt,SORT_PROPS:mt,SCALE_PROPS:yt,ENCODING_NESTED_PROPS:Et,VIEW_PROPS:Tt,toKey:wt,fromKey:xt,getEncodingNestedProp:Ot,isEncodingProperty:At,ALL_ENCODING_PROPS:St,DEFAULT_PROP_PRECEDENCE:Nt,get Property(){return Mt}});const Ft={arc:"arc",area:"area",bar:"bar",image:"image",line:"line",point:"point",rect:"rect",rule:"rule",text:"text",tick:"tick",trail:"trail",circle:"circle",square:"square",geoshape:"geoshape"},kt=Ft.arc,Ut=Ft.area,Pt=Ft.bar,It=Ft.line,Dt=Ft.point,$t=Ft.rect,jt=Ft.rule,Rt=Ft.text,Bt=Ft.tick,Lt=Ft.circle,Gt=Ft.square;function zt(e){return g(["line","area","trail"],e)}p(m(Ft));const Wt="?";function Ht(e){return qt(e)||Yt(e)}function qt(e){return e===Wt}function Yt(e){return!(void 0===e||null==e||!e.enum&&!e.name||Ze.exports.isArray(e))}function Qt(e,t,n){return Ze.exports.extend({},{name:t,enum:n},e===Wt?{}:e)}function Vt(e){const t={},n={};for(const r of e){const e=[0];for(let t=0;t<r.length;t++)r.charAt(t).toUpperCase()===r.charAt(t)&&e.push(t);let i=e.map((e=>r.charAt(e))).join("").toLowerCase();if(n[i])if(e[e.length-1]===r.length-1||(i=e.concat([r.length-1]).map((e=>r.charAt(e))).join("").toLowerCase(),n[i]))for(let e=1;!t[r];e++){const o=`${i}_${e}`;if(!n[o]){t[r]=o,n[o]=!0;break}}else t[r]=i,n[i]=!0;else t[r]=i,n[i]=!0}return t}const Kt={mark:"m",channel:"c",aggregate:"a",autoCount:"#",hasFn:"h",bin:"b",sort:"so",stack:"st",scale:"s",format:"f",axis:"ax",legend:"l",value:"v",timeUnit:"tu",field:"f",type:"t",binProps:{maxbins:"mb",min:"mi",max:"ma",base:"b",step:"s",steps:"ss",minstep:"ms",divide:"d"},sortProps:{field:"f",op:"o",order:"or"},scaleProps:Vt(Ke),axisProps:Vt(ve),legendProps:Vt(be)};function Jt(e){if(st(e))return`${Kt[e.parent]}-${Kt[`${e.parent}Props`][e.child]}`;if(Kt[e])return Kt[e];throw new Error(`Default name undefined for ${e}`)}const Xt=[!1,!0],Zt={mark:[Dt,Pt,It,Ut,$t,Bt,Rt],channel:[C,O,T,w,B,D],band:[void 0],aggregate:[void 0,"mean"],autoCount:Xt,bin:Xt,hasFn:Xt,timeUnit:[void 0,"year","month","minutes","seconds"],field:[void 0],type:[Ne,Ae,Oe,Se],sort:["ascending","descending"],stack:["zero","normalize","center",null],value:[void 0],format:[void 0],title:[void 0],scale:[!0],axis:Xt,legend:Xt,binProps:{maxbins:[5,10,20],extent:[void 0],base:[10],step:[void 0],steps:[void 0],minstep:[void 0],divide:[[5,2]],binned:[!1],anchor:[void 0],nice:[!0]},sortProps:{field:[void 0],op:["min","mean"],order:["ascending","descending"]},scaleProps:{align:[void 0],type:[void 0,ke],domain:[void 0],domainMax:[void 0],domainMid:[void 0],domainMin:[void 0],base:[void 0],exponent:[1,2],constant:[void 0],bins:[void 0],clamp:Xt,nice:Xt,reverse:Xt,round:Xt,zero:Xt,padding:[void 0],paddingInner:[void 0],paddingOuter:[void 0],interpolate:[void 0],range:[void 0],rangeMax:[void 0],rangeMin:[void 0],scheme:[void 0]},axisProps:{aria:[void 0],description:[void 0],zindex:[1,0],offset:[void 0],orient:[void 0],values:[void 0],bandPosition:[void 0],encoding:[void 0],domain:Xt,domainCap:[void 0],domainColor:[void 0],domainDash:[void 0],domainDashOffset:[void 0],domainOpacity:[void 0],domainWidth:[void 0],formatType:[void 0],grid:Xt,gridCap:[void 0],gridColor:[void 0],gridDash:[void 0],gridDashOffset:[void 0],gridOpacity:[void 0],gridWidth:[void 0],format:[void 0],labels:Xt,labelAlign:[void 0],labelAngle:[void 0],labelBaseline:[void 0],labelColor:[void 0],labelExpr:[void 0],labelFlushOffset:[void 0],labelFont:[void 0],labelFontSize:[void 0],labelFontStyle:[void 0],labelFontWeight:[void 0],labelLimit:[void 0],labelLineHeight:[void 0],labelOffset:[void 0],labelOpacity:[void 0],labelSeparation:[void 0],labelOverlap:[void 0],labelPadding:[void 0],labelBound:[void 0],labelFlush:[void 0],maxExtent:[void 0],minExtent:[void 0],position:[void 0],style:[void 0],ticks:Xt,tickBand:[void 0],tickCap:[void 0],tickColor:[void 0],tickCount:[void 0],tickDash:[void 0],tickExtra:[void 0],tickDashOffset:[void 0],tickMinStep:[void 0],tickOffset:[void 0],tickOpacity:[void 0],tickRound:[void 0],tickSize:[void 0],tickWidth:[void 0],title:[void 0],titleAlign:[void 0],titleAnchor:[void 0],titleAngle:[void 0],titleBaseline:[void 0],titleColor:[void 0],titleFont:[void 0],titleFontSize:[void 0],titleFontStyle:[void 0],titleFontWeight:[void 0],titleLimit:[void 0],titleLineHeight:[void 0],titleOpacity:[void 0],titlePadding:[void 0],titleX:[void 0],titleY:[void 0],translate:[void 0]},legendProps:{aria:[void 0],description:[void 0],orient:["left","right"],format:[void 0],type:[void 0],values:[void 0],zindex:[void 0],clipHeight:[void 0],columnPadding:[void 0],columns:[void 0],cornerRadius:[void 0],direction:[void 0],encoding:[void 0],fillColor:[void 0],formatType:[void 0],gridAlign:[void 0],offset:[void 0],padding:[void 0],rowPadding:[void 0],strokeColor:[void 0],labelAlign:[void 0],labelBaseline:[void 0],labelColor:[void 0],labelExpr:[void 0],labelFont:[void 0],labelFontSize:[void 0],labelFontStyle:[void 0],labelFontWeight:[void 0],labelLimit:[void 0],labelOffset:[void 0],labelOpacity:[void 0],labelOverlap:[void 0],labelPadding:[void 0],labelSeparation:[void 0],legendX:[void 0],legendY:[void 0],gradientLength:[void 0],gradientOpacity:[void 0],gradientStrokeColor:[void 0],gradientStrokeWidth:[void 0],gradientThickness:[void 0],symbolDash:[void 0],symbolDashOffset:[void 0],symbolFillColor:[void 0],symbolLimit:[void 0],symbolOffset:[void 0],symbolOpacity:[void 0],symbolSize:[void 0],symbolStrokeColor:[void 0],symbolStrokeWidth:[void 0],symbolType:[void 0],tickCount:[void 0],tickMinStep:[void 0],title:[void 0],titleAnchor:[void 0],titleAlign:[void 0],titleBaseline:[void 0],titleColor:[void 0],titleFont:[void 0],titleFontSize:[void 0],titleFontStyle:[void 0],titleFontWeight:[void 0],titleLimit:[void 0],titleLineHeight:[void 0],titleOpacity:[void 0],titleOrient:[void 0],titlePadding:[void 0]}};function en(e,t,n){if("field"===e||st(e)&&"sort"===e.parent&&"field"===e.child)return t.fieldNames();let r;if(r=st(e)?n.enum[`${e.parent}Props`][e.child]:n.enum[e],void 0!==r)return r;throw new Error(`No default enumValues for ${JSON.stringify(e)}`)}var tn=Object.freeze({__proto__:null,SHORT_WILDCARD:Wt,isWildcard:Ht,isShortWildcard:qt,isWildcardDef:Yt,initWildcard:Qt,DEFAULT_NAME:Kt,getDefaultName:Jt,DEFAULT_ENUM_INDEX:Zt,getDefaultEnumValues:en});const nn={verbose:!1,defaultSpecConfig:{line:{point:!0},scale:{useUnaggregatedDomain:!0}},propertyPrecedence:Nt.map(wt),enum:Zt,numberNominalProportion:.05,numberNominalLimit:40,constraintManuallySpecifiedValue:!1,autoAddCount:!1,hasAppropriateGraphicTypeForMark:!0,omitAggregate:!1,omitAggregatePlotWithDimensionOnlyOnFacet:!0,omitAggregatePlotWithoutDimension:!1,omitBarLineAreaWithOcclusion:!0,omitBarTickWithSize:!0,omitMultipleNonPositionalChannels:!0,omitRaw:!1,omitRawContinuousFieldForAggregatePlot:!0,omitRepeatedField:!0,omitNonPositionalOrFacetOverPositionalChannels:!0,omitTableWithOcclusionIfAutoAddCount:!0,omitVerticalDotPlot:!1,omitInvalidStackSpec:!0,omitNonSumStack:!0,preferredBinAxis:C,preferredTemporalAxis:C,preferredOrdinalAxis:O,preferredNominalAxis:O,preferredFacet:T,minCardinalityForBin:15,maxCardinalityForCategoricalColor:20,maxCardinalityForFacet:20,maxCardinalityForShape:6,timeUnitShouldHaveVariation:!0,typeMatchesSchemaType:!0,stylize:!0,smallRangeStepForHighCardinalityOrFacet:{maxCardinality:10,rangeStep:12},nominalColorScaleForHighCardinality:{maxCardinality:10,palette:"category20"},xAxisOnTopForHighYCardinalityWithoutColumn:{maxCardinality:30},maxGoodCardinalityForFacet:5,maxGoodCardinalityForColor:7,minPercentUniqueForKey:.8,minCardinalityForKey:50};function rn(e){return Object.assign(Object.assign(Object.assign({},Zt),e),{binProps:on(e,"bin"),scaleProps:on(e,"scale"),axisProps:on(e,"axis"),legendProps:on(e,"legend")})}function on(e,t){return Object.assign(Object.assign({},Zt[`${t}Props`]),e[`${t}Props`])}var an=Object.freeze({__proto__:null,DEFAULT_QUERY_CONFIG:nn,extendConfig:function(e){return Object.assign(Object.assign(Object.assign({},nn),e),{enum:rn(e.enum)})}});const sn={argmax:1,argmin:1,average:1,count:1,distinct:1,product:1,max:1,mean:1,median:1,min:1,missing:1,q1:1,q3:1,ci0:1,ci1:1,stderr:1,stdev:1,stdevp:1,sum:1,valid:1,values:1,variance:1,variancep:1};const cn=["count","sum","distinct","valid","missing"];function un(e){return l(e)&&(e=function(e,t){return l(e)?{maxbins:dn(t)}:"binned"===e?{binned:!0}:e.maxbins||e.step?e:Object.assign(Object.assign({},e),{maxbins:dn(t)})}(e,void 0)),"bin"+m(e).map((t=>{return(null==(n=e[t])?void 0:n.selection)?v(`_${t}_${y(e[t])}`):v(`_${t}_${e[t]}`);var n})).join("")}function ln(e){return!0===e||function(e){return u(e)}(e)&&!e.binned}function dn(e){switch(e){case T:case w:case B:case D:case $:case j:case H:case G:case z:case W:case R:return 6;case q:return 4;default:return 10}}p(["mean","average","median","q1","q3","min","max"]);["january","february","march","april","may","june","july","august","september","october","november","december"].map((e=>e.substr(0,3)));["sunday","monday","tuesday","wednesday","thursday","friday","saturday"].map((e=>e.substr(0,3)));var fn=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n};const pn={year:1,quarter:1,month:1,week:1,day:1,dayofyear:1,date:1,hours:1,minutes:1,seconds:1,milliseconds:1},gn=m(pn);function hn(e){return!!pn[e]}function mn(e){return e.startsWith("utc")}function yn(e,t){const n=e.indexOf(t);return!(n<0)&&(!(n>0&&"seconds"===t&&"i"===e.charAt(n-1))&&(!(e.length>n+3&&"day"===t&&"o"===e.charAt(n+3))&&!(n>0&&"year"===t&&"f"===e.charAt(n-1))))}function vn(e){if(!e)return;let t;return d(e)?t={unit:e}:u(e)&&(t=Object.assign(Object.assign({},e),e.unit?{unit:e.unit}:{})),mn(t.unit)&&(t.utc=!0,t.unit=t.unit.substr(3)),t}function bn(e){const t=e&&e.condition;return!!t&&!c(t)&&En(t)}function En(e){return!(!e||!e.field&&"count"!==e.aggregate)}function Tn(e){return e&&e.type}function wn(e,t={}){var n,r,i;let o=e.field;const s=t.prefix;let c=t.suffix,u="";if(function(e){return"count"===e.aggregate}(e))o=function(e){return function(e){return 0===e.indexOf("__")}(e)?e:`__${e}`}("count");else{let a;if(!t.nofn)if(function(e){return"op"in e}(e))a=e.op;else{const{bin:s,aggregate:d,timeUnit:f}=e;ln(s)?(a=un(s),c=(null!==(n=t.binSuffix)&&void 0!==n?n:"")+(null!==(r=t.suffix)&&void 0!==r?r:"")):d?(l=d)&&l.argmax?(u=`["${o}"]`,o=`argmax_${d.argmax}`):!function(e){return!!e&&!!e.argmin}(d)?a=String(d):(u=`["${o}"]`,o=`argmin_${d.argmin}`):f&&(a=function(e){const t=vn(e),{utc:n}=t,r=fn(t,["utc"]);return r.unit?(n?"utc":"")+m(r).map((e=>v(`${"unit"===e?"":`_${e}_`}${r[e]}`))).join(""):(n?"utc":"")+"timeunit"+m(r).map((e=>v(`_${e}_${r[e]}`))).join("")}(f),c=(!g(["range","mid"],t.binSuffix)&&t.binSuffix||"")+(null!==(i=t.suffix)&&void 0!==i?i:""))}a&&(o=o?`${a}_${o}`:a)}var l;return c&&(o=`${o}_${c}`),s&&(o=`${s}_${o}`),t.forAs?`${a(o).join(".")}`:t.expr?function(e,t="datum"){return`${t}[${f(a(e).join("."))}]`}(o,t.expr)+u:function(e){return`${a(e).map(b).join("\\.")}`}(o)+u}function xn(e){switch(e.type){case"nominal":case"ordinal":case"geojson":return!0;case"quantitative":return En(e)&&!!e.bin;case"temporal":return!1}throw new Error(Ee(e.type))}function Cn(e){return!xn(e)}function On(e){return En(e)?e:bn(e)?e.condition:void 0}const An={compatible:!0};function Sn(e,t,n,r){const i=function(e,t,n){var r;switch(t.type){case"nominal":case"ordinal":if(ne(e)||"discrete"===me(e))return"shape"===e&&"ordinal"===t.type&&Ce(we(e,"ordinal")),"ordinal";if(e in ce){if(g(["rect","bar","image","rule"],n))return"band"}else if("arc"===n&&e in ue)return"band";return void 0!==t.band||(i=t)&&("axis"in i||"stack"in i||"impute"in i)&&(null===(r=t.axis)||void 0===r?void 0:r.tickBand)?"band":"point";case"temporal":return ne(e)?"time":"discrete"===me(e)?(Ce(we(e,"temporal")),"ordinal"):En(t)&&t.timeUnit&&vn(t.timeUnit).utc?"utc":"time";case"quantitative":return ne(e)?En(t)&&ln(t.bin)?"bin-ordinal":"linear":"discrete"===me(e)?(Ce(we(e,"quantitative")),"ordinal"):"linear";case"geojson":return}var i;throw new Error(Ee(t.type))}(t,n,r),{type:o}=e;return fe(t)?void 0!==o?function(e,t){if(!fe(e))return!1;switch(e){case C:case O:case _:case N:return Ye(t)||g(["band","point"],t);case B:case H:case G:case z:case W:case L:return Ye(t)||Qe(t)||g(["band","point","ordinal"],t);case D:case $:case j:return"band"!==t;case q:return"ordinal"===t||Qe(t);case R:return"ordinal"===t}}(t,o)?En(n)&&(a=o,s=n.type,!(g([Ae,Ne],s)?void 0===a||qe(a):s===Se?g([De,$e,void 0],a):s!==Oe||g([ke,Ue,Pe,Ie,je,Re,Be,Fe,void 0],a)))?(Ce(function(e,t){return`FieldDef does not work with "${e}" scale. We are using "${t}" scale instead.`}(o,i)),i):o:(Ce(function(e,t,n){return`Channel "${e}" does not work with "${t}" scale. We are using "${n}" scale instead.`}(t,o,i)),i):i:null;var a,s}var Nn;function Mn(e){return e===Ae||e===Ne||e===Nn.KEY}!function(e){e.QUANTITATIVE=Oe,e.ORDINAL=Ae,e.TEMPORAL=Se,e.NOMINAL=Ne,e.KEY="key"}(Nn||(Nn={}));class _n{constructor(e=null){this.index=e?Object.assign({},e):{}}has(e){return wt(e)in this.index}get(e){return this.index[wt(e)]}set(e,t){return this.index[wt(e)]=t,this}setByKey(e,t){this.index[e]=t}map(e){const t=new _n;for(const n in this.index)t.index[n]=e(this.index[n]);return t}size(){return Ze.exports.keys(this.index).length}duplicate(){return new _n(this.index)}}function Fn(e,t){const n=e&&e[t];return!!n&&(c(n)?h(n,(e=>!!e.field)):En(n)||bn(n))}const kn={zero:1,center:1,normalize:1};const Un=new Set([kt,Pt,Ut,jt,Dt,Lt,Gt,It,Rt,Bt]),Pn=new Set([Pt,Ut,kt]);function In(e,t){var n,r;const i="x"===t?"y":"radius",o=e[t],a=e[i];if(En(o)&&En(a))if("quantitative"===Tn(o)&&"quantitative"===Tn(a)){if(o.stack)return t;if(a.stack)return i;const e=En(o)&&!!o.aggregate;if(e!==(En(a)&&!!a.aggregate))return e?t:i;{const e=null===(n=o.scale)||void 0===n?void 0:n.type,s=null===(r=a.scale)||void 0===r?void 0:r.type;if(e&&"linear"!==e)return i;if(s&&"linear"!==s)return t}}else{if("quantitative"===Tn(o))return t;if("quantitative"===Tn(a))return i}else{if("quantitative"===Tn(o))return t;if("quantitative"===Tn(a))return i}}function Dn(e,t,n={}){const r=function(e){return e.type}(e)?e.type:e;if(!Un.has(r))return null;const i=In(t,"x")||In(t,"theta");if(!i)return null;const o=t[i],a=En(o)?wn(o,{}):void 0;let s=function(e){switch(e){case"x":return"y";case"y":return"x";case"theta":return"radius";case"radius":return"theta"}}(i),u=t[s],d=En(u)?wn(u,{}):void 0;d===a&&(d=void 0,u=void 0,s=void 0);const f=se.reduce(((e,n)=>{if("tooltip"!==n&&Fn(t,n)){const i=t[n];for(const t of null!=(r=i)?c(r)?r:[r]:[]){const r=On(t);if(r.aggregate)continue;const i=wn(r,{});i&&i===d||e.push({channel:n,fieldDef:r})}}var r;return e}),[]);let p;if(void 0!==o.stack?p=l(o.stack)?o.stack?"zero":null:o.stack:f.length>0&&Pn.has(r)&&(p="zero"),!p||!(p in kn))return null;var m,y;if(function(e){return h(ie,(t=>{if(Fn(e,t)){const n=e[t];if(c(n))return h(n,(e=>!!e.aggregate));{const e=On(n);return e&&!!e.aggregate}}return!1}))}(t)&&0===f.length)return null;if(o.scale&&o.scale.type&&o.scale.type!==Fe){if(n.disallowNonLinearStack)return null;Ce(function(e){return`Cannot stack non-linear scale (${e}).`}(o.scale.type))}return En(y=t[function(e){switch(e){case C:return A;case O:return S;case k:return P;case U:return I;case _:return F;case N:return M}}(i)])||function(e){return!!e&&"datum"in e}(y)?(void 0!==o.stack&&Ce(`Cannot stack "${m=i}" if there is already "${m}2".`),null):(En(o)&&o.aggregate&&!g(cn,o.aggregate)&&Ce(`Stacking is applied even though the aggregate function is non-summative ("${o.aggregate}").`),{groupbyChannel:u?s:void 0,groupbyField:d,fieldChannel:i,impute:null!==o.impute&&zt(r),stackBy:f,offset:p})}function $n(e){return Ze.exports.extend(e.data?{data:e.data}:{},e.transform?{transform:e.transform}:{},e.width?{width:e.width}:{},e.height?{height:e.height}:{},e.background?{background:e.background}:{},e.padding?{padding:e.padding}:{},e.title?{title:e.title}:{},{mark:e.mark,encodings:Ze.exports.keys(e.encoding).map((t=>{const n={channel:t},r=e.encoding[t];for(const e in r)lt(e)&&void 0!==r[e]&&(et(["bin","scale","axis","legend"],e)&&null===r[e]?n[e]=!1:n[e]=r[e]);return or(n)&&"count"===n.aggregate&&!n.field&&(n.field="*"),n}))},e.config?{config:e.config}:{})}function jn(e){return rt(e.encodings,(e=>or(e)&&!Ht(e.aggregate)&&!!e.aggregate||cr(e)))}function Rn(e){if(!Gn(e))return null;const t=lr(e.encodings,{schema:null,wildcardMode:"null"});return Dn(e.mark,t,{disallowNonLinearStack:!0})}function Bn(e){for(const t of e.encodings)if(void 0!==t[Mt.STACK]&&!Ht(t[Mt.STACK]))return t[Mt.STACK]}function Ln(e){for(const t of e.encodings)if(void 0!==t[Mt.STACK]&&!Ht(t.channel))return t.channel;return null}function Gn(e){if(Ht(e.mark))return!1;const t=[Mt.STACK,Mt.CHANNEL,Mt.MARK,Mt.FIELD,Mt.AGGREGATE,Mt.AUTOCOUNT,Mt.SCALE,Ot("scale","type"),Mt.TYPE],n=Ze.exports.toMap(it(St,t)),r=e.encodings.filter((e=>!sr(e)));for(const e of r)if(zn(e,{exclude:n}))return!1;return!0}function zn(e,t={}){if(!Ze.exports.isObject(e))return!1;for(const n in e)if(e.hasOwnProperty(n)){if(Ht(e[n])&&(!t.exclude||!t.exclude[n])||zn(e[n],t))return!0}return!1}var Wn=Object.freeze({__proto__:null,fromSpec:$n,isAggregate:jn,getVlStack:Rn,getStackOffset:Bn,getStackChannel:Ln,hasRequiredStackProperties:Gn,hasWildcard:function(e,t={}){const n=t.exclude?Ze.exports.toMap(t.exclude.map(wt)):{};if(Ht(e.mark)&&!n.mark)return!0;for(const t of e.encodings)if(zn(t,n))return!0;return!1}});function Hn(e){return e.map((e=>qn(e)))}function qn(e){return t=>void 0!==e[t]?e[t]:t}function Yn(e,t){return Ht(e)?!qt(e)&&e.enum?Wt+JSON.stringify(e.enum):Wt:t?t(e):e}function Qn(e,t){return t?t(e):e}const Vn=new _n,Kn=[].concat(Nt,mt,[Mt.TRANSFORM,Mt.STACK],Tt).reduce(((e,t)=>e.set(t,!0)),new _n);const Jn={axis:{x:!0,y:!0,row:!0,column:!0},legend:{color:!0,opacity:!0,size:!0,shape:!0},scale:{x:!0,y:!0,color:!0,opacity:!0,row:!0,column:!0,size:!0,shape:!0},sort:{x:!0,y:!0,path:!0,order:!0},stack:{x:!0,y:!0}};function Xn(e,t=Kn,n=Vn){const r=[];let i;if(t.get(Mt.MARK)&&r.push(Yn(e.mark,n.get(Mt.MARK))),e.transform&&e.transform.length>0&&r.push(`transform:${JSON.stringify(e.transform)}`),t.get(Mt.STACK)&&(i=Rn(e)),e.encodings){const o=e.encodings.reduce(((e,r)=>{if(!sr(r)){let o;o=i&&r.channel===i.fieldChannel?Zn(Object.assign(Object.assign({},r),{stack:i.offset}),t,n):Zn(r,t,n),o&&e.push(o)}return e}),[]).sort().join("|");o&&r.push(o)}for(const n of Tt){const i=n.toString();if(t.get(n)&&e[i]){const t=e[i];r.push(`${i}=${JSON.stringify(t)}`)}}return r.join("|")}function Zn(e,t=Kn,n=Vn){const r=[];if(t.get(Mt.CHANNEL)&&r.push(Yn(e.channel,n.get(Mt.CHANNEL))),or(e)){const i=er(e,t,n);i&&r.push(i)}else ir(e)?r.push(e.value):ar(e)&&r.push("autocount()");return r.join(":")}function er(e,t=Kn,n=Vn){if(t.get(Mt.AGGREGATE)&&sr(e))return"-";const r=function(e,t,n){if(t.get(Mt.AGGREGATE)&&e.aggregate&&!Ht(e.aggregate))return Qn(e.aggregate,n.get(Mt.AGGREGATE));if(t.get(Mt.AGGREGATE)&&cr(e))return Qn("count",n.get(Mt.AGGREGATE));if(t.get(Mt.TIMEUNIT)&&e.timeUnit&&!Ht(e.timeUnit))return Qn(e.timeUnit,n.get(Mt.TIMEUNIT));if(t.get(Mt.BIN)&&e.bin&&!Ht(e.bin))return"bin";{let n=null;for(const r of[Mt.AGGREGATE,Mt.AUTOCOUNT,Mt.TIMEUNIT,Mt.BIN]){const i=e[r];t.get(r)&&e[r]&&Ht(i)&&(n=n||{},n[r]=qt(i)?i:i.enum)}return n&&e.hasFn&&(n.hasFn=!0),n}}(e,t,n),i=function(e,t,n){const r=[];if(!Ze.exports.isBoolean(e.bin)&&!qt(e.bin)){const i=e.bin;for(const e in i){const o=Ot("bin",e);o&&t.get(o)&&void 0!==i[e]&&r.push({key:e,value:Yn(i[e],n.get(o))})}r.sort(((e,t)=>e.key.localeCompare(t.key)))}for(const i of[Mt.SCALE,Mt.SORT,Mt.STACK,Mt.AXIS,Mt.LEGEND])if((Ht(e.channel)||Jn[i][e.channel])&&t.get(i)&&void 0!==e[i]){const o=e[i];if(Ze.exports.isBoolean(o)||null===o)r.push({key:`${i}`,value:o||!1});else if(Ze.exports.isString(o))r.push({key:`${i}`,value:Qn(JSON.stringify(o),n.get(i))});else{const e=[];for(const r in o){const a=Ot(i,r);a&&t.get(a)&&void 0!==o[r]&&e.push({key:r,value:Yn(o[r],n.get(a))})}if(e.length>0){const t=e.sort(((e,t)=>e.key.localeCompare(t.key))).reduce(((e,t)=>(e[t.key]=t.value,e)),{});r.push({key:`${i}`,value:JSON.stringify(t)})}}}return r}(e,t,n);let o;if(or(e)){if(o=t.get("field")?Yn(e.field,n.get("field")):"...",t.get(Mt.TYPE))if(Ht(e.type))o+=`,${Yn(e.type,n.get(Mt.TYPE))}`;else{o+=`,${Yn(`${e.type||Oe}`.substr(0,1),n.get(Mt.TYPE))}`}o+=i.map((e=>{const t=e.value instanceof Array?`[${e.value}]`:e.value;return`,${e.key}=${t}`})).join("")}else ar(e)&&(o="*,q");if(!o)return null;if(r){return`${Ze.exports.isString(r)?r:Wt+(Ze.exports.keys(r).length>0?JSON.stringify(r):"")}(${o})`}return o}function tr(e,t,n){const r=[];let i=0;for(let o=0;o<n;o++){const n=e.indexOf(t,i);if(-1===n)break;r.push(e.substring(i,n)),i=n+1}if(r.push(e.substr(i)),r.length!==n+1)for(;r.length!==n+1;)r.push("");return r}var nr;!function(e){function t(e){const t={};t.field=e[0],t.type=function(e){if(e)switch(e=e.toLowerCase()){case"q":case Oe:return"quantitative";case"t":case Se:return"temporal";case"o":case Ae:return"ordinal";case"n":case Ne:return"nominal";case Me:return"geojson"}}(e[1].toUpperCase())||"?";const r=e[2];let i=0,o=0;for(;o<r.length;){const e=r.indexOf("=",o);let a;if(-1===e)break;{const s=r.substring(o,e);if("{"===r[o+s.length+1]){const e=o+s.length+1;i=n(e,r,"}");const t=r.substring(e,i+1);a=JSON.parse(t),o=i+2}else if("["===r[o+s.length+1]){const e=o+s.length+1,t=n(e,r,"]"),i=r.substring(e,t+1);a=JSON.parse(i),o=t+2}else{const e=o;let t=r.indexOf(",",o+s.length);-1===t&&(t=r.length),o=t+1,a=JSON.parse(r.substring(e+s.length+1,t))}ft(s)?t[s]=a:(t.bin=t.bin||{},t.bin[s]=a)}}return t}function n(e,t,n){for(let r=e;r<t.length;r++)if(t[r]===n)return r}function r(e){const r={};if("?"===e[0]){const i=n(1,e,"}"),o=JSON.parse(e.substring(1,i+1));for(const e in o)Ze.exports.isArray(o[e])?r[e]={enum:o[e]}:r[e]=o[e];return Object.assign(Object.assign({},r),t(tr(e.substring(i+2,e.length-1),",",2)))}{const n=e.substring(0,e.indexOf("(")),r=tr(e.substring(n.length+1,e.length-1),",",2);if(d(i=n)&&sn[i])return Object.assign({aggregate:n},t(r));if(mn(n)||hn(n))return Object.assign({timeUnit:n},t(r));if("bin"===n)return Object.assign({bin:{}},t(r))}var i}e.encoding=function(e,n){const i=-1!==n.indexOf("(")?r(n):t(tr(n,",",2));return Object.assign({channel:e},i)},e.rawFieldDef=t,e.getClosingIndex=n,e.fn=r}(nr||(nr={}));var rr=Object.freeze({__proto__:null,getReplacerIndex:Hn,getReplacer:qn,value:Yn,replace:Qn,REPLACE_NONE:Vn,INCLUDE_ALL:Kn,vlSpec:function(e,t=Kn,n=Vn){return Xn($n(e),t,n)},PROPERTY_SUPPORTED_CHANNELS:Jn,spec:Xn,encoding:Zn,fieldDef:er,parse:function(e){const t=e.split("|"),n={mark:t[0],encodings:[]};for(let e=1;e<t.length;e++){const r=tr(t[e],":",1),i=r[0],o=r[1];if(re[i]||"?"===i){const e=nr.encoding(i,o);n.encodings.push(e)}else"transform"!==i||(n.transform=JSON.parse(o))}return n},splitWithTail:tr,get shorthandParser(){return nr}});function ir(e){return null!=e&&void 0!==e.value}function or(e){return null!=e&&(e.field||"count"===e.aggregate)}function ar(e){return null!=e&&"autoCount"in e}function sr(e){return ar(e)&&!1===e.autoCount}function cr(e){return ar(e)&&!0===e.autoCount}const ur=[Mt.AGGREGATE,Mt.BIN,Mt.TIMEUNIT,Mt.FIELD,Mt.TYPE,Mt.SCALE,Mt.SORT,Mt.AXIS,Mt.LEGEND,Mt.STACK,Mt.FORMAT];function lr(e,t){const n={};for(const r of e){if(sr(r))continue;const{channel:e}=r;if(Ht(e))throw new Error("Cannot convert wildcard channel to a fixed channel");const i=ir(r)?dr(r):fr(r,t);if(null!==i)n[e]=i;else if("null"===t.wildcardMode)return null}return n}function dr(e){const{value:t}=e;return Ht(t)?null:{value:t}}function fr(e,t={}){const{props:n=ur,schema:r,wildcardMode:i="skip"}=t;if(or(e)){const t={};for(const o of n){let n=e[o];if(Ht(n)){if("skip"===i)continue;return null}if(void 0!==n){if(!(!Jn[o]||Jn[o][e.channel]))continue;if(ft(o)&&Ze.exports.isObject(n)){n=Object.assign({},n);for(const e in n)if(Ht(n[e])){if("null"===i)return null;delete n[e]}}if("bin"===o&&!1===n)continue;"type"===o&&"key"===n?t.type="nominal":t[o]=n}if(o===Mt.SCALE&&r&&e.type===Ae){const n=e.scale,{ordinalDomain:i}=r.fieldSchema(e.field);null!==n&&i&&(t[Mt.SCALE]=Object.assign({domain:i},Ze.exports.isObject(n)?n:{}))}}return t}if(!1===e.autoCount)throw new Error("Cannot convert {autoCount: false} into a field def");return{aggregate:"count",field:"*",type:"quantitative"}}function pr(e){return or(e)?!gr(e)&&"temporal"!==e.type:ar(e)}function gr(e){if(or(e)){const t=fr(e,{props:e.field?["field","bin","timeUnit","type"]:["bin","timeUnit","type"]});return xn(t)||!!t.timeUnit}return!1}function hr(e){const t=!0===e.scale||e.scale===Wt?{}:e.scale||{},{type:n,channel:r,timeUnit:i,bin:o}=e;if(Ht(t.type)||Ht(n)||Ht(r)||Ht(o))return;if("row"===r||"column"===r||"facet"===r)return;if(t.type)return t.type;if("temporal"===n&&Ht(i))return;if("quantitative"===n&&Ht(o))return;const a={type:n===Nn.KEY?"nominal":n,timeUnit:i,bin:o};return Sn({type:t.type},r,a,undefined)}var mr=Object.freeze({__proto__:null,isValueQuery:ir,isFieldQuery:or,isAutoCountQuery:ar,isDisabledAutoCountQuery:sr,isEnabledAutoCountQuery:cr,toEncoding:lr,toValueDef:dr,toFieldDef:fr,isContinuous:function(e){return or(e)?Cn(fr(e,{props:["bin","timeUnit","field","type"]})):ar(e)},isMeasure:pr,isDimension:gr,scaleType:hr}),yr={exports:{}},vr={exports:{}};!function(e,t){!function(e){var t=new Date,n=new Date;function r(e,i,o,a){function s(t){return e(t=new Date(+t)),t}return s.floor=s,s.round=function(t){var n=new Date(+t),r=new Date(t-1);return e(n),e(r),i(r,1),t-n<r-t?n:r},s.ceil=function(t){return e(t=new Date(t-1)),i(t,1),t},s.offset=function(e,t){return i(e=new Date(+e),null==t?1:Math.floor(t)),e},s.range=function(t,n,r){var o=[];if(t=new Date(t-1),n=new Date(+n),r=null==r?1:Math.floor(r),!(t<n&&r>0))return o;for(i(t,1),e(t),t<n&&o.push(new Date(+t));i(t,r),e(t),t<n;)o.push(new Date(+t));return o},s.filter=function(t){return r((function(n){for(;e(n),!t(n);)n.setTime(n-1)}),(function(e,n){for(;--n>=0;)for(;i(e,1),!t(e););}))},o&&(s.count=function(r,i){return t.setTime(+r),n.setTime(+i),e(t),e(n),Math.floor(o(t,n))},s.every=function(e){return e=Math.floor(e),isFinite(e)&&e>0?e>1?s.filter(a?function(t){return a(t)%e==0}:function(t){return s.count(0,t)%e==0}):s:null}),s}var i=r((function(){}),(function(e,t){e.setTime(+e+t)}),(function(e,t){return t-e}));i.every=function(e){return e=Math.floor(e),isFinite(e)&&e>0?e>1?r((function(t){t.setTime(Math.floor(t/e)*e)}),(function(t,n){t.setTime(+t+n*e)}),(function(t,n){return(n-t)/e})):i:null};var o=r((function(e){e.setMilliseconds(0)}),(function(e,t){e.setTime(+e+1e3*t)}),(function(e,t){return(t-e)/1e3}),(function(e){return e.getSeconds()})),a=r((function(e){e.setSeconds(0,0)}),(function(e,t){e.setTime(+e+6e4*t)}),(function(e,t){return(t-e)/6e4}),(function(e){return e.getMinutes()})),s=r((function(e){e.setMinutes(0,0,0)}),(function(e,t){e.setTime(+e+36e5*t)}),(function(e,t){return(t-e)/36e5}),(function(e){return e.getHours()})),c=r((function(e){e.setHours(0,0,0,0)}),(function(e,t){e.setDate(e.getDate()+t)}),(function(e,t){return(t-e-6e4*(t.getTimezoneOffset()-e.getTimezoneOffset()))/864e5}),(function(e){return e.getDate()-1}));function u(e){return r((function(t){t.setHours(0,0,0,0),t.setDate(t.getDate()-(t.getDay()+7-e)%7)}),(function(e,t){e.setDate(e.getDate()+7*t)}),(function(e,t){return(t-e-6e4*(t.getTimezoneOffset()-e.getTimezoneOffset()))/6048e5}))}var l=u(0),d=u(1),f=u(2),p=u(3),g=u(4),h=u(5),m=u(6),y=r((function(e){e.setHours(0,0,0,0),e.setDate(1)}),(function(e,t){e.setMonth(e.getMonth()+t)}),(function(e,t){return t.getMonth()-e.getMonth()+12*(t.getFullYear()-e.getFullYear())}),(function(e){return e.getMonth()})),v=r((function(e){e.setHours(0,0,0,0),e.setMonth(0,1)}),(function(e,t){e.setFullYear(e.getFullYear()+t)}),(function(e,t){return t.getFullYear()-e.getFullYear()}),(function(e){return e.getFullYear()})),b=r((function(e){e.setUTCMilliseconds(0)}),(function(e,t){e.setTime(+e+1e3*t)}),(function(e,t){return(t-e)/1e3}),(function(e){return e.getUTCSeconds()})),E=r((function(e){e.setUTCSeconds(0,0)}),(function(e,t){e.setTime(+e+6e4*t)}),(function(e,t){return(t-e)/6e4}),(function(e){return e.getUTCMinutes()})),T=r((function(e){e.setUTCMinutes(0,0,0)}),(function(e,t){e.setTime(+e+36e5*t)}),(function(e,t){return(t-e)/36e5}),(function(e){return e.getUTCHours()})),w=r((function(e){e.setUTCHours(0,0,0,0)}),(function(e,t){e.setUTCDate(e.getUTCDate()+t)}),(function(e,t){return(t-e)/864e5}),(function(e){return e.getUTCDate()-1}));function x(e){return r((function(t){t.setUTCHours(0,0,0,0),t.setUTCDate(t.getUTCDate()-(t.getUTCDay()+7-e)%7)}),(function(e,t){e.setUTCDate(e.getUTCDate()+7*t)}),(function(e,t){return(t-e)/6048e5}))}var C=x(0),O=x(1),A=x(2),S=x(3),N=x(4),M=x(5),_=x(6),F=r((function(e){e.setUTCHours(0,0,0,0),e.setUTCDate(1)}),(function(e,t){e.setUTCMonth(e.getUTCMonth()+t)}),(function(e,t){return t.getUTCMonth()-e.getUTCMonth()+12*(t.getUTCFullYear()-e.getUTCFullYear())}),(function(e){return e.getUTCMonth()})),k=r((function(e){e.setUTCHours(0,0,0,0),e.setUTCMonth(0,1)}),(function(e,t){e.setUTCFullYear(e.getUTCFullYear()+t)}),(function(e,t){return t.getUTCFullYear()-e.getUTCFullYear()}),(function(e){return e.getUTCFullYear()})),U=i.range,P=o.range,I=a.range,D=s.range,$=c.range,j=l.range,R=d.range,B=f.range,L=p.range,G=g.range,z=h.range,W=m.range,H=l.range,q=y.range,Y=v.range,Q=i,V=U,K=b.range,J=E.range,X=T.range,Z=w.range,ee=C.range,te=O.range,ne=A.range,re=S.range,ie=N.range,oe=M.range,ae=_.range,se=C.range,ce=F.range,ue=k.range,le="0.1.1";e.version=le,e.milliseconds=U,e.seconds=P,e.minutes=I,e.hours=D,e.days=$,e.sundays=j,e.mondays=R,e.tuesdays=B,e.wednesdays=L,e.thursdays=G,e.fridays=z,e.saturdays=W,e.weeks=H,e.months=q,e.years=Y,e.utcMillisecond=Q,e.utcMilliseconds=V,e.utcSeconds=K,e.utcMinutes=J,e.utcHours=X,e.utcDays=Z,e.utcSundays=ee,e.utcMondays=te,e.utcTuesdays=ne,e.utcWednesdays=re,e.utcThursdays=ie,e.utcFridays=oe,e.utcSaturdays=ae,e.utcWeeks=se,e.utcMonths=ce,e.utcYears=ue,e.millisecond=i,e.second=o,e.minute=a,e.hour=s,e.day=c,e.sunday=l,e.monday=d,e.tuesday=f,e.wednesday=p,e.thursday=g,e.friday=h,e.saturday=m,e.week=l,e.month=y,e.year=v,e.utcSecond=b,e.utcMinute=E,e.utcHour=T,e.utcDay=w,e.utcSunday=C,e.utcMonday=O,e.utcTuesday=A,e.utcWednesday=S,e.utcThursday=N,e.utcFriday=M,e.utcSaturday=_,e.utcWeek=C,e.utcMonth=F,e.utcYear=k,e.interval=r}(t)}(0,vr.exports);var br=vr.exports,Er=new Date,Tr=new Date(2e3,0,1),wr=new Date(Date.UTC(2e3,0,1));function xr(e){return Er.setTime(+e),Er}function Cr(e,t,n,r,i,o){var a={type:e,date:t,unit:n};return r?a.step=r:a.minstep=1,null!=i&&(a.min=i),null!=o&&(a.max=o),a}function Or(e,t,n,r,i,o){return Cr(e,(function(e){return t.offset(n,e)}),(function(e){return t.count(n,e)}),r,i,o)}var Ar=[Or("second",br.second,Tr),Or("minute",br.minute,Tr),Or("hour",br.hour,Tr),Or("day",br.day,Tr,[1,7]),Or("month",br.month,Tr,[1,3,6]),Or("year",br.year,new Date(Tr).setFullYear(0)),Cr("seconds",(function(e){return new Date(1970,0,1,0,0,e)}),(function(e){return xr(e).getSeconds()}),null,0,59),Cr("minutes",(function(e){return new Date(1970,0,1,0,e)}),(function(e){return xr(e).getMinutes()}),null,0,59),Cr("hours",(function(e){return new Date(1970,0,1,e)}),(function(e){return xr(e).getHours()}),null,0,23),Cr("weekdays",(function(e){return new Date(1970,0,4+e)}),(function(e){return xr(e).getDay()}),[1],0,6),Cr("dates",(function(e){return new Date(1970,0,e)}),(function(e){return xr(e).getDate()}),[1],1,31),Cr("months",(function(e){return new Date(1970,e%12,1)}),(function(e){return xr(e).getMonth()}),[1],0,11)],Sr=[Or("second",br.utcSecond,wr),Or("minute",br.utcMinute,wr),Or("hour",br.utcHour,wr),Or("day",br.utcDay,wr,[1,7]),Or("month",br.utcMonth,wr,[1,3,6]),Or("year",br.utcYear,new Date(wr).setUTCFullYear(0)),Cr("seconds",(function(e){return new Date(Date.UTC(1970,0,1,0,0,e))}),(function(e){return xr(e).getUTCSeconds()}),null,0,59),Cr("minutes",(function(e){return new Date(Date.UTC(1970,0,1,0,e))}),(function(e){return xr(e).getUTCMinutes()}),null,0,59),Cr("hours",(function(e){return new Date(Date.UTC(1970,0,1,e))}),(function(e){return xr(e).getUTCHours()}),null,0,23),Cr("weekdays",(function(e){return new Date(Date.UTC(1970,0,4+e))}),(function(e){return xr(e).getUTCDay()}),[1],0,6),Cr("dates",(function(e){return new Date(Date.UTC(1970,0,e))}),(function(e){return xr(e).getUTCDate()}),[1],1,31),Cr("months",(function(e){return new Date(Date.UTC(1970,e%12,1))}),(function(e){return xr(e).getUTCMonth()}),[1],0,11)],Nr=[[31536e6,5],[7776e6,4],[2592e6,4],[12096e5,3],[6048e5,3],[1728e5,3],[864e5,3],[432e5,2],[216e5,2],[108e5,2],[36e5,2],[18e5,1],[9e5,1],[3e5,1],[6e4,1],[3e4,0],[15e3,0],[5e3,0],[1e3,0]];function Mr(e){var t,n,r={};for(t=0,n=e.length;t<n;++t)r[e[t].type]=e[t];return r.find=function(t,n,r){return function(e,t,n,r){var i,o,a,s=Nr[0];for(i=1,o=Nr.length;i<o;++i)if(t>(s=Nr[i])[0]){if((a=t/s[0])>r)return e[Nr[i-1][1]];if(a>=n)return e[s[1]]}return e[Nr[o-1][1]]}(e,t,n,r)},r}yr.exports=Mr(Ar),yr.exports.utc=Mr(Sr);var _r=Ze.exports,Fr=yr.exports;function kr(e){if(!e)throw Error("Missing binning options.");var t,n,r,i,o,a,s,c=e.maxbins||15,u=e.base||10,l=Math.log(u),d=e.div||[5,2],f=e.min,p=e.max,g=p-f;if(e.step)t=e.step;else if(e.steps)t=e.steps[Math.min(e.steps.length-1,function(e,t,n,r){for(;n<r;){var i=n+r>>>1;_r.cmp(e[i],t)<0?n=i+1:r=i}return n}(e.steps,g/c,0,e.steps.length))];else{for(n=Math.ceil(Math.log(c)/l),r=e.minstep||0,t=Math.max(r,Math.pow(u,Math.round(Math.log(g)/l)-n));Math.ceil(g/t)>c;)t*=u;for(a=0;a<d.length;++a)(o=t/d[a])>=r&&g/o<=c&&(t=o)}return i=(o=Math.log(t))>=0?0:1+~~(-o/l),s=Math.pow(u,-i-1),{start:f=Math.min(f,Math.floor(f/t+s)*t),stop:p=Math.ceil(p/t)*t,step:t,unit:{precision:i},value:Ur,index:Pr}}function Ur(e){return this.start+this.step*Math.floor((e-this.start+1e-14)/this.step)}function Pr(e){return Math.floor((e-this.start)/this.step+1e-14)}function Ir(e){return this.unit.date(Ur.call(this,e))}function Dr(e){return Pr.call(this,this.unit.unit(e))}kr.date=function(e){if(!e)throw Error("Missing date binning options.");var t=e.utc?Fr.utc:Fr,n=e.min,r=e.max,i=e.maxbins||20,o=e.minbins||4,a=+r-+n,s=e.unit?t[e.unit]:t.find(a,o,i),c=kr({min:null!=s.min?s.min:s.unit(n),max:null!=s.max?s.max:s.unit(r),maxbins:i,minstep:s.minstep,steps:s.step});return c.unit=s,c.index=Dr,e.raw||(c.value=Ir),c};var $r=kr,jr=Ze.exports,Rr="__types__",Br={boolean:jr.boolean,integer:jr.number,number:jr.number,date:jr.date,string:function(e){return null==e||""===e?null:e+""}},Lr={boolean:function(e){return"true"===e||"false"===e||jr.isBoolean(e)},integer:function(e){return Lr.number(e)&&(e=+e)==~~e},number:function(e){return!isNaN(+e)&&!jr.isDate(e)},date:function(e){return!isNaN(Date.parse(e))}};function Gr(e){return jr.keys(e)}function zr(e){return"["+e+"]"}function Wr(e,t){var n,r,i;if(e=jr.array(e),t=jr.$(t),e[Rr]&&(n=t(e[Rr]),jr.isString(n)))return n;for(r=0,i=e.length;!jr.isValid(n)&&r<i;++r)n=t?t(e[r]):e[r];return jr.isDate(n)?"date":jr.isNumber(n)?"number":jr.isBoolean(n)?"boolean":jr.isString(n)?"string":null}function Hr(e,t,n){var r,i,o;e=jr.array(e),t=jr.$(t);var a=["boolean","integer","number","date"];for(r=0;r<e.length;++r){for(o=t?t(e[r]):e[r],i=0;i<a.length;++i)n&&n.test(o)||!jr.isValid(o)||Lr[a[i]](o)||(a.splice(i,1),i-=1);if(0===a.length)return"string"}return a[0]}Wr.annotation=function(e,t){if(!t)return e&&e[Rr]||null;e[Rr]=t},Wr.all=function(e,t){if(e.length){var n=t?jr.identity:(t=Gr(e[0]),zr);return t.reduce((function(t,r){return t[r]=Wr(e,n(r)),t}),{})}},Wr.infer=Hr,Wr.inferAll=function(e,t,n){var r=t?jr.identity:(t=Gr(e[0]),zr);return t.reduce((function(t,i){return t[i]=Hr(e,r(i),n),t}),{})},Wr.parsers=Br;var qr=Wr,Yr={exports:{}},Qr={exports:{}};!function(e){var t=Ze.exports,n=e.exports;n.repeat=function(e,t){var n,r=Array(t);for(n=0;n<t;++n)r[n]=e;return r},n.zeros=function(e){return n.repeat(0,e)},n.range=function(e,t,n){if(arguments.length<3&&(n=1,arguments.length<2&&(t=e,e=0)),(t-e)/n==1/0)throw new Error("Infinite range");var r,i=[],o=-1;if(n<0)for(;(r=e+n*++o)>t;)i.push(r);else for(;(r=e+n*++o)<t;)i.push(r);return i},n.random={},n.random.uniform=function(e,t){void 0===t&&(t=void 0===e?1:e,e=0);var r=t-e,i=function(){return e+r*Math.random()};return i.samples=function(e){return n.zeros(e).map(i)},i.pdf=function(n){return n>=e&&n<=t?1/r:0},i.cdf=function(n){return n<e?0:n>t?1:(n-e)/r},i.icdf=function(t){return t>=0&&t<=1?e+t*r:NaN},i},n.random.integer=function(e,t){void 0===t&&(t=e,e=0);var r=t-e,i=function(){return e+Math.floor(r*Math.random())};return i.samples=function(e){return n.zeros(e).map(i)},i.pdf=function(n){return n===Math.floor(n)&&n>=e&&n<t?1/r:0},i.cdf=function(n){var i=Math.floor(n);return i<e?0:i>=t?1:(i-e+1)/r},i.icdf=function(t){return t>=0&&t<=1?e-1+Math.floor(t*r):NaN},i},n.random.normal=function(e,t){var r;e=e||0,t=t||1;var i=function(){var n,i,o=0,a=0;if(void 0!==r)return o=r,r=void 0,o;do{n=(o=2*Math.random()-1)*o+(a=2*Math.random()-1)*a}while(0===n||n>1);return i=Math.sqrt(-2*Math.log(n)/n),r=e+a*i*t,e+o*i*t};return i.samples=function(e){return n.zeros(e).map(i)},i.pdf=function(n){var r=Math.exp(Math.pow(n-e,2)/(-2*Math.pow(t,2)));return 1/(t*Math.sqrt(2*Math.PI))*r},i.cdf=function(n){var r,i=(n-e)/t,o=Math.abs(i);if(o>37)r=0;else{var a=Math.exp(-o*o/2);o<7.07106781186547?(r=a*((((((.0352624965998911*o+.700383064443688)*o+6.37396220353165)*o+33.912866078383)*o+112.079291497871)*o+221.213596169931)*o+220.206867912376),r/=((((((.0883883476483184*o+1.75566716318264)*o+16.064177579207)*o+86.7807322029461)*o+296.564248779674)*o+637.333633378831)*o+793.826512519948)*o+440.413735824752):r=a/(o+1/(o+2/(o+3/(o+4/(o+.65)))))/2.506628274631}return i>0?1-r:r},i.icdf=function(n){if(n<=0||n>=1)return NaN;var r=2*n-1,i=8*(Math.PI-3)/(3*Math.PI*(4-Math.PI)),o=2/(Math.PI*i)+Math.log(1-Math.pow(r,2))/2,a=Math.log(1-r*r)/i,s=(r>0?1:-1)*Math.sqrt(Math.sqrt(o*o-a)-o);return e+t*Math.SQRT2*s},i},n.random.bootstrap=function(e,r){var i=e.filter(t.isValid),o=i.length,a=r?n.random.normal(0,r):null,s=function(){return i[~~(Math.random()*o)]+(a?a():0)};return s.samples=function(e){return n.zeros(e).map(s)},s}}(Qr),function(e){var t=Ze.exports,n=qr,r=Qr.exports,i=e.exports;function o(e,t,n){var o=e&&e.nullh||0,a=r.random.normal(0,1),s=i.mean(t,n),c=i.stdev(t,n)/Math.sqrt(i.count.valid(t,n));if(0===c)return s-o==0?1:0;var u=(s-o)/c;return 2*a.cdf(-Math.abs(u))}function a(e,n,r,o){var a,s=o?n.map(t.$(r)):n,c=o?n.map(t.$(o)):r,u=i.count(s),l=i.count(c),d=Array();if(u!==l)throw Error("Array lengths must match.");for(a=0;a<u;++a)t.isValid(s[a])&&t.isValid(c[a])&&d.push(s[a]-c[a]);return i.z.test(d,e&&e.nullh||0)}function s(e,n,o,a){var s=a?n.map(t.$(o)):n,c=a?n.map(t.$(a)):o,u=i.count.valid(s),l=i.count.valid(c),d=r.random.normal(0,1),f=i.mean(s)-i.mean(c)-(e&&e.nullh||0),p=Math.sqrt(i.variance(s)/u+i.variance(c)/l);if(0===p)return 0===f?1:0;var g=f/p;return 2*d.cdf(-Math.abs(g))}i.unique=function(e,n,r){n=t.$(n),r=r||[];var i,o,a,s={};for(o=0,a=e.length;o<a;++o)(i=n?n(e[o]):e[o])in s||(s[i]=1,r.push(i));return r},i.count=function(e){return e&&e.length||0},i.count.valid=function(e,n){n=t.$(n);var r,i,o,a=0;for(i=0,o=e.length;i<o;++i)r=n?n(e[i]):e[i],t.isValid(r)&&(a+=1);return a},i.count.missing=function(e,n){n=t.$(n);var r,i,o=0;for(r=0,i=e.length;r<i;++r)null==(n?n(e[r]):e[r])&&(o+=1);return o},i.count.distinct=function(e,n){n=t.$(n);var r,i,o,a={},s=0;for(i=0,o=e.length;i<o;++i)(r=n?n(e[i]):e[i])in a||(a[r]=1,s+=1);return s},i.count.map=function(e,n){n=t.$(n);var r,i,o,a={};for(i=0,o=e.length;i<o;++i)a[r=n?n(e[i]):e[i]]=r in a?a[r]+1:1;return a},i.median=function(e,n){return n&&(e=e.map(t.$(n))),e=e.filter(t.isValid).sort(t.cmp),i.quantile(e,.5)},i.quartile=function(e,n){n&&(e=e.map(t.$(n))),e=e.filter(t.isValid).sort(t.cmp);var r=i.quantile;return[r(e,.25),r(e,.5),r(e,.75)]},i.quantile=function(e,n,r){void 0===r&&(r=n,n=t.identity),n=t.$(n);var i=(e.length-1)*r+1,o=Math.floor(i),a=+n(e[o-1]),s=i-o;return s?a+s*(n(e[o])-a):a},i.sum=function(e,n){n=t.$(n);for(var r,i=0,o=0,a=e.length;o<a;++o)r=n?n(e[o]):e[o],t.isValid(r)&&(i+=r);return i},i.mean=function(e,n){n=t.$(n);var r,i,o,a,s=0;for(r=0,o=0,i=e.length;r<i;++r)a=n?n(e[r]):e[r],t.isValid(a)&&(s+=(a-s)/++o);return s},i.mean.geometric=function(e,n){n=t.$(n);var r,i,o,a,s=1;for(a=0,r=0,i=e.length;a<i;++a)if(o=n?n(e[a]):e[a],t.isValid(o)){if(o<=0)throw Error("Geometric mean only defined for positive values.");s*=o,++r}return s=r>0?Math.pow(s,1/r):0},i.mean.harmonic=function(e,n){n=t.$(n);var r,i,o,a,s=0;for(a=0,r=0,i=e.length;a<i;++a)o=n?n(e[a]):e[a],t.isValid(o)&&(s+=1/o,++r);return r/s},i.variance=function(e,n){if(n=t.$(n),!t.isArray(e)||e.length<2)return 0;var r,i,o,a,s=0,c=0;for(i=0,o=0;i<e.length;++i)a=n?n(e[i]):e[i],t.isValid(a)&&(c+=(r=a-s)*(a-(s+=r/++o)));return c/=o-1},i.stdev=function(e,t){return Math.sqrt(i.variance(e,t))},i.modeskew=function(e,t){var n=i.mean(e,t),r=i.median(e,t),o=i.stdev(e,t);return 0===o?0:(n-r)/o},i.min=function(e,t){return i.extent(e,t)[0]},i.max=function(e,t){return i.extent(e,t)[1]},i.extent=function(e,n){n=t.$(n);var r,i,o,a,s=e.length;for(a=0;a<s;++a)if(o=n?n(e[a]):e[a],t.isValid(o)){r=i=o;break}for(;a<s;++a)o=n?n(e[a]):e[a],t.isValid(o)&&(o<r&&(r=o),o>i&&(i=o));return[r,i]},i.extent.index=function(e,n){n=t.$(n);var r,i,o,a,s=-1,c=-1,u=e.length;for(a=0;a<u;++a)if(o=n?n(e[a]):e[a],t.isValid(o)){r=i=o,s=c=a;break}for(;a<u;++a)o=n?n(e[a]):e[a],t.isValid(o)&&(o<r&&(r=o,s=a),o>i&&(i=o,c=a));return[s,c]},i.dot=function(e,n,r){var i,o,a=0;if(r)for(n=t.$(n),r=t.$(r),i=0;i<e.length;++i)(o=n(e[i])*r(e[i]))==o&&(a+=o);else{if(e.length!==n.length)throw Error("Array lengths must match.");for(i=0;i<e.length;++i)(o=e[i]*n[i])==o&&(a+=o)}return a},i.dist=function(e,n,r,i){var o,a,s=t.isFunction(r)||t.isString(r),c=e,u=s?e:n,l=s?i:r,d=2===l||null==l,f=e.length,p=0;for(s&&(n=t.$(n),r=t.$(r)),a=0;a<f;++a)o=s?n(c[a])-r(u[a]):c[a]-u[a],p+=d?o*o:Math.pow(Math.abs(o),l);return d?Math.sqrt(p):Math.pow(p,1/l)},i.cohensd=function(e,n,r){var o=r?e.map(t.$(n)):e,a=r?e.map(t.$(r)):n,s=i.mean(o),c=i.mean(a),u=i.count.valid(o),l=i.count.valid(a);if(u+l-2<=0)return 0;var d=i.variance(o),f=i.variance(a),p=Math.sqrt(((u-1)*d+(l-1)*f)/(u+l-2));return 0===p?0:(s-c)/p},i.covariance=function(e,n,r){var o,a,s,c,u,l=r?e.map(t.$(n)):e,d=r?e.map(t.$(r)):n,f=l.length,p=i.mean(l),g=i.mean(d),h=0,m=0;if(f!==d.length)throw Error("Input lengths must match.");for(o=0;o<f;++o)if(a=l[o],c=t.isValid(a),s=d[o],u=t.isValid(s),c&&u)h+=(a-p)*(s-g),++m;else if(c||u)throw Error("Valid values must align.");return h/(m-1)},i.rank=function(e,n){n=t.$(n)||t.identity;var r,i,o,a=e.map((function(e,t){return{idx:t,val:n(e)}})).sort(t.comparator("val")),s=e.length,c=Array(s),u=-1,l={};for(r=0;r<s;++r){if(i=a[r].val,u<0&&l===i)u=r-1;else if(u>-1&&l!==i){for(o=1+(r-1+u)/2;u<r;++u)c[a[u].idx]=o;u=-1}c[a[r].idx]=r+1,l=i}if(u>-1)for(o=1+(s-1+u)/2;u<s;++u)c[a[u].idx]=o;return c},i.cor=function(e,n,r){var o=r;r=o?e.map(t.$(r)):n,n=o?e.map(t.$(n)):e;var a=i.dot(n,r),s=i.mean(n),c=i.mean(r),u=i.stdev(n),l=i.stdev(r),d=e.length;return(a-d*s*c)/((d-1)*u*l)},i.cor.rank=function(e,t,n){var r,o,a,s=n?i.rank(e,t):i.rank(e),c=n?i.rank(e,n):i.rank(t),u=e.length;for(r=0,o=0;r<u;++r)o+=(a=s[r]-c[r])*a;return 1-6*o/(u*(u*u-1))},i.cor.dist=function(e,n,r){var o,a,s,c,u=r?e.map(t.$(n)):e,l=r?e.map(t.$(r)):n,d=i.dist.mat(u),f=i.dist.mat(l),p=d.length;for(o=0,a=0,s=0,c=0;o<p;++o)a+=d[o]*d[o],s+=f[o]*f[o],c+=d[o]*f[o];return Math.sqrt(c/Math.sqrt(a*s))},i.linearRegression=function(e,n,r){var o,a,s=r?e.map(t.$(n)):e,c=r?e.map(t.$(r)):n,u=s.length,l=i.covariance(s,c),d=i.stdev(s),f=i.stdev(c),p=l/(d*d),g=i.mean(c)-p*i.mean(s),h={slope:p,intercept:g,R:l/(d*f),rss:0};for(a=0;a<u;++a)t.isValid(s[a])&&t.isValid(c[a])&&(o=p*s[a]+g-c[a],h.rss+=o*o);return h},i.bootstrap={},i.bootstrap.ci=function(e,n,o,a,s){var c,u,l,d,f,p,g;for(t.isFunction(n)||t.isString(n)?(c=e.map(t.$(n)),u=o,l=a,d=s):(c=e,u=n,l=o,d=a),u=u?+u:1e3,l=l||.05,f=r.random.bootstrap(c,d),g=0,p=Array(u);g<u;++g)p[g]=i.mean(f.samples(c.length));return p.sort(t.numcmp),[i.quantile(p,l/2),i.quantile(p,1-l/2)]},i.z={},i.z.ci=function(e,n,o){var a=e,s=n;(t.isFunction(n)||t.isString(n))&&(a=e.map(t.$(n)),s=o);var c=.05===(s=s||.05)?1.96:r.random.normal(0,1).icdf(1-s/2),u=i.mean(a),l=i.stdev(a)/Math.sqrt(i.count.valid(a));return[u-c*l,u+c*l]},i.z.test=function(e,n,r,i){return t.isFunction(r)||t.isString(r)?(i&&i.paired?a:s)(i,e,n,r):t.isArray(n)?(r&&r.paired?a:s)(r,e,n):t.isFunction(n)||t.isString(n)?o(r,e,n):o(n,e)},i.dist.mat=function(e){var t,n,i,o=e.length,a=o*o,s=Array(a),c=r.zeros(o),u=0;for(n=0;n<o;++n)for(s[n*o+n]=0,i=n+1;i<o;++i)s[n*o+i]=t=Math.abs(e[n]-e[i]),s[i*o+n]=t,c[n]+=t,c[i]+=t;for(n=0;n<o;++n)u+=c[n],c[n]/=o;for(u/=a,n=0;n<o;++n)for(i=n;i<o;++i)s[n*o+i]+=u-c[n]-c[i],s[i*o+n]=s[n*o+i];return s},i.entropy=function(e,n){n=t.$(n);var r,i,o=0,a=0,s=e.length;for(r=0;r<s;++r)o+=n?n(e[r]):e[r];if(0===o)return 0;for(r=0;r<s;++r)(i=(n?n(e[r]):e[r])/o)&&(a+=i*Math.log(i));return-a/Math.LN2},i.mutual=function(e,n,r,i){var o,a,s,c=i?e.map(t.$(n)):e,u=i?e.map(t.$(r)):n,l=i?e.map(t.$(i)):r,d={},f={},p=l.length,g=0,h=0,m=0;for(s=0;s<p;++s)d[c[s]]=0,f[u[s]]=0;for(s=0;s<p;++s)d[c[s]]+=l[s],f[u[s]]+=l[s],g+=l[s];for(a=1/(g*Math.LN2),s=0;s<p;++s)0!==l[s]&&(o=g*l[s]/(d[c[s]]*f[u[s]]),h+=l[s]*a*Math.log(o),m+=l[s]*a*Math.log(l[s]/g));return[h,1+h/m]},i.mutual.info=function(e,t,n,r){return i.mutual(e,t,n,r)[0]},i.mutual.dist=function(e,t,n,r){return i.mutual(e,t,n,r)[1]},i.profile=function(e,r){var o,a,s,c,u,l=0,d=0,f=0,p=0,g=null,h=null,m=0,y=[],v={};for(s=0;s<e.length;++s)v[c=r?r(e[s]):e[s]]=c in v?v[c]+1:(p+=1,1),null==c?++f:t.isValid(c)&&(u="string"==typeof c?c.length:c,(null===g||u<g)&&(g=u),(null===h||u>h)&&(h=u),m+=(o=u-l)*(u-(l+=o/++d)),y.push(u));return m/=d-1,a=Math.sqrt(m),y.sort(t.cmp),{type:n(e,r),unique:v,count:e.length,valid:d,missing:f,distinct:p,min:g,max:h,mean:l,stdev:a,median:c=i.quantile(y,.5),q1:i.quantile(y,.25),q3:i.quantile(y,.75),modeskew:0===a?0:(l-c)/a}},i.summary=function(e,n){var r=(n=n||t.keys(e[0])).map((function(n){var r=i.profile(e,t.$(n));return r.field=n,r}));return r.__summary__=!0,r}}(Yr);var Vr=new Date,Kr=new Date;function Jr(e,t,n,r){function i(t){return e(t=0===arguments.length?new Date:new Date(+t)),t}return i.floor=function(t){return e(t=new Date(+t)),t},i.ceil=function(n){return e(n=new Date(n-1)),t(n,1),e(n),n},i.round=function(e){var t=i(e),n=i.ceil(e);return e-t<n-e?t:n},i.offset=function(e,n){return t(e=new Date(+e),null==n?1:Math.floor(n)),e},i.range=function(n,r,o){var a,s=[];if(n=i.ceil(n),o=null==o?1:Math.floor(o),!(n<r&&o>0))return s;do{s.push(a=new Date(+n)),t(n,o),e(n)}while(a<n&&n<r);return s},i.filter=function(n){return Jr((function(t){if(t>=t)for(;e(t),!n(t);)t.setTime(t-1)}),(function(e,r){if(e>=e)if(r<0)for(;++r<=0;)for(;t(e,-1),!n(e););else for(;--r>=0;)for(;t(e,1),!n(e););}))},n&&(i.count=function(t,r){return Vr.setTime(+t),Kr.setTime(+r),e(Vr),e(Kr),Math.floor(n(Vr,Kr))},i.every=function(e){return e=Math.floor(e),isFinite(e)&&e>0?e>1?i.filter(r?function(t){return r(t)%e==0}:function(t){return i.count(0,t)%e==0}):i:null}),i}var Xr=Jr((function(){}),(function(e,t){e.setTime(+e+t)}),(function(e,t){return t-e}));Xr.every=function(e){return e=Math.floor(e),isFinite(e)&&e>0?e>1?Jr((function(t){t.setTime(Math.floor(t/e)*e)}),(function(t,n){t.setTime(+t+n*e)}),(function(t,n){return(n-t)/e})):Xr:null};var Zr=1e3,ei=6e4,ti=36e5,ni=864e5,ri=6048e5;Jr((function(e){e.setTime(e-e.getMilliseconds())}),(function(e,t){e.setTime(+e+t*Zr)}),(function(e,t){return(t-e)/Zr}),(function(e){return e.getUTCSeconds()})),Jr((function(e){e.setTime(e-e.getMilliseconds()-e.getSeconds()*Zr)}),(function(e,t){e.setTime(+e+t*ei)}),(function(e,t){return(t-e)/ei}),(function(e){return e.getMinutes()})),Jr((function(e){e.setTime(e-e.getMilliseconds()-e.getSeconds()*Zr-e.getMinutes()*ei)}),(function(e,t){e.setTime(+e+t*ti)}),(function(e,t){return(t-e)/ti}),(function(e){return e.getHours()})),Jr((e=>e.setHours(0,0,0,0)),((e,t)=>e.setDate(e.getDate()+t)),((e,t)=>(t-e-(t.getTimezoneOffset()-e.getTimezoneOffset())*ei)/ni),(e=>e.getDate()-1));function ii(e){return Jr((function(t){t.setDate(t.getDate()-(t.getDay()+7-e)%7),t.setHours(0,0,0,0)}),(function(e,t){e.setDate(e.getDate()+7*t)}),(function(e,t){return(t-e-(t.getTimezoneOffset()-e.getTimezoneOffset())*ei)/ri}))}ii(0);ii(1),ii(2),ii(3),ii(4),ii(5),ii(6);var oi=Jr((function(e){e.setDate(1),e.setHours(0,0,0,0)}),(function(e,t){e.setMonth(e.getMonth()+t)}),(function(e,t){return t.getMonth()-e.getMonth()+12*(t.getFullYear()-e.getFullYear())}),(function(e){return e.getMonth()})),ai=Jr((function(e){e.setMonth(0,1),e.setHours(0,0,0,0)}),(function(e,t){e.setFullYear(e.getFullYear()+t)}),(function(e,t){return t.getFullYear()-e.getFullYear()}),(function(e){return e.getFullYear()}));ai.every=function(e){return isFinite(e=Math.floor(e))&&e>0?Jr((function(t){t.setFullYear(Math.floor(t.getFullYear()/e)*e),t.setMonth(0,1),t.setHours(0,0,0,0)}),(function(t,n){t.setFullYear(t.getFullYear()+n*e)})):null};Jr((function(e){e.setUTCSeconds(0,0)}),(function(e,t){e.setTime(+e+t*ei)}),(function(e,t){return(t-e)/ei}),(function(e){return e.getUTCMinutes()})),Jr((function(e){e.setUTCMinutes(0,0,0)}),(function(e,t){e.setTime(+e+t*ti)}),(function(e,t){return(t-e)/ti}),(function(e){return e.getUTCHours()})),Jr((function(e){e.setUTCHours(0,0,0,0)}),(function(e,t){e.setUTCDate(e.getUTCDate()+t)}),(function(e,t){return(t-e)/ni}),(function(e){return e.getUTCDate()-1}));function si(e){return Jr((function(t){t.setUTCDate(t.getUTCDate()-(t.getUTCDay()+7-e)%7),t.setUTCHours(0,0,0,0)}),(function(e,t){e.setUTCDate(e.getUTCDate()+7*t)}),(function(e,t){return(t-e)/ri}))}si(0);si(1),si(2),si(3),si(4),si(5),si(6);var ci=Jr((function(e){e.setUTCDate(1),e.setUTCHours(0,0,0,0)}),(function(e,t){e.setUTCMonth(e.getUTCMonth()+t)}),(function(e,t){return t.getUTCMonth()-e.getUTCMonth()+12*(t.getUTCFullYear()-e.getUTCFullYear())}),(function(e){return e.getUTCMonth()})),ui=Jr((function(e){e.setUTCMonth(0,1),e.setUTCHours(0,0,0,0)}),(function(e,t){e.setUTCFullYear(e.getUTCFullYear()+t)}),(function(e,t){return t.getUTCFullYear()-e.getUTCFullYear()}),(function(e){return e.getUTCFullYear()}));ui.every=function(e){return isFinite(e=Math.floor(e))&&e>0?Jr((function(t){t.setUTCFullYear(Math.floor(t.getUTCFullYear()/e)*e),t.setUTCMonth(0,1),t.setUTCHours(0,0,0,0)}),(function(t,n){t.setUTCFullYear(t.getUTCFullYear()+n*e)})):null};const li="year",di="quarter",fi="month",pi="week",gi="date",hi="day",mi="dayofyear",yi="hours",vi="minutes",bi="seconds",Ei="milliseconds";[li,di,fi,pi,gi,hi,mi,yi,vi,bi,Ei].reduce(((e,t,n)=>(e[t]=1+n,e)),{}),oi.every(3),ci.every(3);const Ti=$r;const wi={nominal:0,key:1,ordinal:2,temporal:3,quantitative:4};class xi{constructor(e){this._tableSchema=e,e.fields.sort((function(e,t){return wi[e.vlType]<wi[t.vlType]?-1:wi[e.vlType]>wi[t.vlType]?1:e.name.localeCompare(t.name)})),e.fields.forEach(((e,t)=>e.index=t)),this._fieldSchemaIndex=e.fields.reduce(((e,t)=>(e[t.name]=t,e)),{})}fieldNames(){return this._tableSchema.fields.map((e=>e.name))}get fieldSchemas(){return this._tableSchema.fields}fieldSchema(e){return this._fieldSchemaIndex[e]}tableSchema(){const e=Ze.exports.duplicate(this._tableSchema);return e.fields.sort(((e,t)=>e.originalIndex-t.originalIndex)),e}primitiveType(e){return this._fieldSchemaIndex[e]?this._fieldSchemaIndex[e].type:null}vlType(e){return this._fieldSchemaIndex[e]?this._fieldSchemaIndex[e].vlType:null}cardinality(e,t=!0,n=!1){const r=this._fieldSchemaIndex[e.field];if(e.aggregate||ar(e)&&e.autoCount)return 1;if(e.bin){let t;t="boolean"==typeof e.bin?{maxbins:dn(e.channel)}:"?"===e.bin?{enum:[!0,!1]}:e.bin;const n=t.maxbins;return r.binStats[n]||(r.binStats[n]=Ci(n,r.stats)),r.binStats[n].distinct}if(e.timeUnit){if(t)switch(e.timeUnit){case bi:case vi:return 60;case yi:return 24;case hi:return 7;case gi:return 31;case fi:return 12;case di:return 4;case Ei:return 1e3}const i=e.timeUnit;let o=r.timeStats;return o&&o[i]||(o=Object.assign(Object.assign({},o),{[i]:Si(e.timeUnit,r.stats)})),n?o[i].distinct-Ni(o[i].unique,["Invalid Date",null]):o[i].distinct}return r?n?r.stats.distinct-Ni(r.stats.unique,[NaN,null]):r.stats.distinct:null}timeUnitHasVariation(e){if(!e.timeUnit)return;if(e.timeUnit===hi){const t=Ze.exports.extend({},e,{timeUnit:gi});if(this.cardinality(t,!1,!0)<=1)return!1}const t=e.timeUnit;for(const n of gn)if(yn(t,n)){const t=Ze.exports.extend({},e,{timeUnit:n});if(this.cardinality(t,!1,!0)<=1)return!1}return!0}domain(e){const t=this._fieldSchemaIndex[e.field];let n=Ze.exports.keys(t.stats.unique);return t.vlType===Oe?[+t.stats.min,+t.stats.max]:t.type===Mi.DATETIME?[t.stats.min,t.stats.max]:t.type===Mi.INTEGER||t.type===Mi.NUMBER?(n=n.map((e=>+e)),n.sort(Ze.exports.cmp)):t.vlType===Ae&&t.ordinalDomain?t.ordinalDomain:n.map((e=>"null"===e?null:e)).sort(Ze.exports.cmp)}stats(e){const t=this._fieldSchemaIndex[e.field];return t?t.stats:null}}function Ci(e,t){const n=Ti({min:t.min,max:t.max,maxbins:e}),r=Ze.exports.extend({},t);return r.unique=function(e,t){const n={};for(const r in t){let i;i=null===r?null:isNaN(Number(r))?NaN:e.value(Number(r)),n[i]=(n[i]||0)+t[r]}return n}(n,t.unique),r.distinct=(n.stop-n.start)/n.step,r.min=n.start,r.max=n.stop,r}const Oi={year:"setFullYear",month:"setMonth",date:"setDate",hours:"setHours",minutes:"setMinutes",seconds:"setSeconds",milliseconds:"setMilliseconds",dayofyear:null,week:null,quarter:null,day:null};function Ai(e,t){const n=Oi[e];return{setDateMethod:t?`setUTC${n.substr(3)}`:n,getDateMethod:`get${t?"UTC":""}${n.substr(3)}`}}function Si(e,t){const n=Ze.exports.extend({},t),r={};return Ze.exports.keys(t.unique).forEach((function(n){const i="null"===n?null:new Date(n);let o;o=null===i?null:isNaN(i.getTime())?"Invalid Date":(e===hi?i.getDay():function(e,t){const n=mn(e),r=n?new Date(Date.UTC(1972,0,1,0,0,0,0)):new Date(1972,0,1,0,0,0,0);for(const i of gn)if(yn(e,i))switch(i){case hi:throw new Error("Cannot convert to TimeUnits containing 'day'");case mi:throw new Error("Cannot convert to TimeUnits containing 'dayofyear'");case pi:throw new Error("Cannot convert to TimeUnits containing 'week'");case di:{const{getDateMethod:e,setDateMethod:i}=Ai("month",n);r[i](3*Math.floor(t[e]()/3));break}default:{const{getDateMethod:e,setDateMethod:o}=Ai(i,n);r[o](t[e]())}}return r}(e,i)).toString(),r[o]=(r[o]||0)+t.unique[n]})),n.unique=r,n.distinct=Ze.exports.keys(r).length,n}function Ni(e,t){return t.reduce((function(t,n){return e[n]?t+1:t}),0)}var Mi;!function(e){e[e.STRING="string"]="STRING",e[e.NUMBER="number"]="NUMBER",e[e.INTEGER="integer"]="INTEGER",e[e.BOOLEAN="boolean"]="BOOLEAN",e[e.DATETIME="datetime"]="DATETIME"}(Mi||(Mi={}));var _i=Object.freeze({__proto__:null,build:function(e,t={},n={fields:[]}){t=Ze.exports.extend({},nn,t);const r=Yr.exports.summary(e),i=qr.inferAll(e),o=n.fields.reduce(((e,t)=>(e[t.name]=t,e)),{}),a=r.map((function(n,r){const a=n.field,s="date"===i[a]?Mi.DATETIME:i[a],c=n.distinct;let u;if(s===Mi.NUMBER)u=Oe;else if(s===Mi.INTEGER)u=c<t.numberNominalLimit&&c/n.count<t.numberNominalProportion?Ne:Oe;else if(s===Mi.DATETIME){u=Se,n.min=new Date(e[0][a]),n.max=new Date(e[0][a]);for(const t of e){const e=new Date(t[a]).getTime();e<n.min.getTime()&&(n.min=new Date(e)),e>n.max.getTime()&&(n.max=new Date(e))}}else u=Ne;u===Ne&&c/n.count>t.minPercentUniqueForKey&&n.count>t.minCardinalityForKey&&(u=Nn.KEY);let l={name:a,originalIndex:r,vlType:u,type:s,stats:n,timeStats:{},binStats:{}};const d=o[l.name];return l=Ze.exports.extend(l,d),l}));for(const e of a)if(e.vlType===Oe)for(const n of t.enum.binProps.maxbins)e.binStats[n]=Ci(n,e.stats);else if(e.vlType===Se)for(const n of t.enum.timeUnit)if(void 0!==n)if("object"==typeof n){if(!("unit"in n))throw new Error("Unrecognized TimeUnit type when calculating fieldSchema.stats");e.timeStats[n.unit]=Si(n.unit,e.stats)}else e.timeStats[n]=Si(n,e.stats);const s=Object.assign(Object.assign({},n),{fields:a});return new xi(s)},Schema:xi,get PrimitiveType(){return Mi}});class Fi{constructor(e){this.constraint=e}name(){return this.constraint.name}description(){return this.constraint.description}properties(){return this.constraint.properties}strict(){return this.constraint.strict}}class ki extends Fi{constructor(e){super(e)}hasAllRequiredPropertiesSpecific(e){return tt(this.constraint.properties,(t=>{if(st(t)){const n=t.parent,r=t.child;return!e[n]||!Ht(e[n][r])}return!e[t]||!Ht(e[t])}))}satisfy(e,t,n,r){return!this.constraint.allowWildcardForProperties&&!this.hasAllRequiredPropertiesSpecific(e)||this.constraint.satisfy(e,t,n,r)}}const Ui=[{name:"aggregateOpSupportedByType",description:"Aggregate function should be supported by data type.",properties:[Mt.TYPE,Mt.AGGREGATE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>!e.aggregate||!Mn(e.type)},{name:"asteriskFieldWithCountOnly",description:'Field="*" should be disallowed except aggregate="count"',properties:[Mt.FIELD,Mt.AGGREGATE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>"*"===e.field==("count"===e.aggregate)},{name:"minCardinalityForBin",description:"binned quantitative field should not have too low cardinality",properties:[Mt.BIN,Mt.FIELD,Mt.TYPE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>{if(e.bin&&e.type===Oe){const n={channel:e.channel,field:e.field,type:e.type};return t.cardinality(n)>=r.minCardinalityForBin}return!0}},{name:"binAppliedForQuantitative",description:"bin should be applied to quantitative field only.",properties:[Mt.TYPE,Mt.BIN],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>!e.bin||e.type===Oe},{name:"channelFieldCompatible",description:"encoding channel's range type be compatible with channel type.",properties:[Mt.CHANNEL,Mt.TYPE,Mt.BIN,Mt.TIMEUNIT],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>{var i;const o=Object.assign({field:"f"},fr(e,{schema:t,props:["bin","timeUnit","type"]})),{compatible:a}=function(e,t){const n=e.type;if("geojson"===n&&"shape"!==t)return{compatible:!1,warning:`Channel ${t} should not be used with a geojson data.`};switch(t){case T:case w:case x:return Cn(e)?{compatible:!1,warning:Te(t)}:An;case C:case O:case D:case $:case j:case Y:case V:case K:case J:case X:case Z:case L:case _:case N:case ee:return An;case U:case I:case k:case P:return n!==Oe?{compatible:!1,warning:`Channel ${t} should be used with a quantitative field only, not ${e.type} field.`}:An;case G:case z:case W:case H:case B:case F:case M:case A:case S:return"nominal"!==n||e.sort?An:{compatible:!1,warning:`Channel ${t} should not be used with an unsorted discrete field.`};case q:return g(["ordinal","nominal"],e.type)?An:{compatible:!1,warning:"StrokeDash channel should be used with only discrete data."};case R:return g(["ordinal","nominal","geojson"],e.type)?An:{compatible:!1,warning:"Shape channel should be used with only either discrete or geojson data."};case Q:return"nominal"!==e.type||"sort"in e?An:{compatible:!1,warning:"Channel order is inappropriate for nominal field, which has no inherent order."}}}(o,e.channel);if(a)return!0;{const t="row"===e.channel||"column"===e.channel||"facet"===e.channel,n=o.timeUnit&&(null===(i=vn(o.timeUnit))||void 0===i?void 0:i.unit);return!(!t||!n||!hn(n)&&!mn(n))}}},{name:"hasFn",description:"A field with as hasFn flag should have one of aggregate, timeUnit, or bin.",properties:[Mt.AGGREGATE,Mt.BIN,Mt.TIMEUNIT],allowWildcardForProperties:!0,strict:!0,satisfy:(e,t,n,r)=>!e.hasFn||(!!e.aggregate||!!e.bin||!!e.timeUnit)},{name:"omitScaleZeroWithBinnedField",description:"Do not use scale zero with binned field",properties:[Mt.SCALE,Ot("scale","zero"),Mt.BIN],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>!e.bin||!e.scale||!0!==e.scale.zero},{name:"onlyOneTypeOfFunction",description:"Only of of aggregate, autoCount, timeUnit, or bin should be applied at the same time.",properties:[Mt.AGGREGATE,Mt.AUTOCOUNT,Mt.TIMEUNIT,Mt.BIN],allowWildcardForProperties:!0,strict:!0,satisfy:(e,t,n,r)=>{if(or(e)){return(!Ht(e.aggregate)&&e.aggregate?1:0)+(!Ht(e.bin)&&e.bin?1:0)+(!Ht(e.timeUnit)&&e.timeUnit?1:0)<=1}return!0}},{name:"timeUnitAppliedForTemporal",description:"Time unit should be applied to temporal field only.",properties:[Mt.TYPE,Mt.TIMEUNIT],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>!e.timeUnit||e.type===Se},{name:"timeUnitShouldHaveVariation",description:"A particular time unit should be applied only if they produce unique values.",properties:[Mt.TIMEUNIT,Mt.TYPE],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n,r)=>!e.timeUnit||e.type!==Se||(!n.has("timeUnit")&&!r.constraintManuallySpecifiedValue||t.timeUnitHasVariation(e))},{name:"scalePropertiesSupportedByScaleType",description:"Scale properties must be supported by correct scale type",properties:[].concat(yt,[Mt.SCALE,Mt.TYPE]),allowWildcardForProperties:!0,strict:!0,satisfy:(e,t,n,r)=>{if(e.scale){const t=e.scale,n=hr(e);if(null==n)return!0;for(const e in t){if("type"===e||"name"===e||"enum"===e)continue;const t=e;if("point"===n){if(!Je("point",t)&&!Je("band",t))return!1}else if(!Je(n,t))return!1}}return!0}},{name:"scalePropertiesSupportedByChannel",description:"Not all scale properties are supported by all encoding channels",properties:[].concat(yt,[Mt.SCALE,Mt.CHANNEL]),allowWildcardForProperties:!0,strict:!0,satisfy:(e,t,n,r)=>{if(e){const t=e.channel,n=e.scale;if(t&&!Ht(t)&&n){if("row"===t||"column"===t||"facet"===t)return!1;for(const e in n){if(!n.hasOwnProperty(e))continue;if("type"===e||"name"===e||"enum"===e)continue;if(!(void 0===Xe(t,e)))return!1}}}return!0}},{name:"typeMatchesPrimitiveType",description:"Data type should be supported by field's primitive type.",properties:[Mt.FIELD,Mt.TYPE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>{if("*"===e.field)return!0;const i=t.primitiveType(e.field),o=e.type;if(!n.has("field")&&!n.has("type")&&!r.constraintManuallySpecifiedValue)return!0;switch(i){case Mi.BOOLEAN:case Mi.STRING:return o!==Oe&&o!==Se;case Mi.NUMBER:case Mi.INTEGER:return o!==Se;case Mi.DATETIME:return o===Se;case null:return!1}throw new Error("Not implemented")}},{name:"typeMatchesSchemaType",description:"Enumerated data type of a field should match the field's type in the schema.",properties:[Mt.FIELD,Mt.TYPE],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n,r)=>!(n.has("field")||n.has("type")||r.constraintManuallySpecifiedValue)||("*"===e.field?e.type===Oe:t.vlType(e.field)===e.type)},{name:"maxCardinalityForCategoricalColor",description:"Categorical channel should not have too high cardinality",properties:[Mt.CHANNEL,Mt.FIELD],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n,r)=>e.channel!==D||e.type!==Ne&&e.type!==Nn.KEY||t.cardinality(e)<=r.maxCardinalityForCategoricalColor},{name:"maxCardinalityForFacet",description:"Row/column channel should not have too high cardinality",properties:[Mt.CHANNEL,Mt.FIELD,Mt.BIN,Mt.TIMEUNIT],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n,r)=>e.channel!==T&&e.channel!==w||t.cardinality(e)<=r.maxCardinalityForFacet},{name:"maxCardinalityForShape",description:"Shape channel should not have too high cardinality",properties:[Mt.CHANNEL,Mt.FIELD,Mt.BIN,Mt.TIMEUNIT],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n,r)=>e.channel!==R||t.cardinality(e)<=r.maxCardinalityForShape},{name:"dataTypeAndFunctionMatchScaleType",description:"Scale type must match data type",properties:[Mt.TYPE,Mt.SCALE,Ot("scale","type"),Mt.TIMEUNIT,Mt.BIN],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>{if(e.scale){const t=e.type,n=hr(e);if(Mn(t))return void 0===n||qe(n);if(t===Se)return e.timeUnit?et([De,$e,void 0],n)||qe(n):et([De,$e,void 0],n);if(t===Oe)return e.bin?et([Fe,void 0],n):et([ke,Ue,Pe,je,Re,Fe,void 0],n)}return!0}},{name:"stackIsOnlyUsedWithXY",description:"stack should only be allowed for x and y channels",properties:[Mt.STACK,Mt.CHANNEL],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>!e.stack||(e.channel===C||e.channel===O)}].map((e=>new ki(e)));Ui.reduce(((e,t)=>(e[t.name()]=t,e)),{});const Pi=Ui.reduce(((e,t)=>{for(const n of t.properties())e.set(n,e.get(n)||[]),e.get(n).push(t);return e}),new _n),Ii=[{name:"doesNotSupportConstantValue",description:"row, column, x, y, order, and detail should not work with constant values.",properties:[Mt.TYPE,Mt.AGGREGATE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n,r)=>!et(["row","column","x","y","detail","order"],e.channel)}].map((e=>new ki(e)));Ii.reduce(((e,t)=>(e[t.name()]=t,e)),{});const Di=Ii.reduce(((e,t)=>{for(const n of t.properties())e.set(n,e.get(n)||[]),e.get(n).push(t);return e}),new _n);function $i(e,t,n,r,i,o){const a=Pi.get(e)||[],s=r.getEncodingQueryByIndex(n);for(const e of a)if(e.strict()||o[e.name()]){if(!e.satisfy(s,i,r.wildcardIndex.encodings[n],o)){const n=`(enc) ${e.name()}`;return o.verbose&&console.log(`${n} failed with ${r.toShorthand()} for ${t.name}`),n}}const c=Di.get(e)||[];for(const e of c)if((e.strict()||o[e.name()])&&ir(s)){if(!e.satisfy(s,i,r.wildcardIndex.encodings[n],o)){const n=`(enc) ${e.name()}`;return o.verbose&&console.log(`${n} failed with ${r.toShorthand()} for ${t.name}`),n}}return null}var ji=Object.freeze({__proto__:null,checkEncoding:$i});const Ri=se.reduce(((e,t)=>(e[t]=!0,e)),{});class Bi extends Fi{constructor(e){super(e)}hasAllRequiredPropertiesSpecific(e){return tt(this.constraint.properties,(t=>{if(t===Mt.MARK)return!Ht(e.getMark());if(st(t)){const n=t.parent,r=t.child;return tt(e.getEncodings(),(e=>!e[n]||!Ht(e[n][r])))}if(!At(t))throw new Error("UNIMPLEMENTED");return tt(e.getEncodings(),(e=>!e[t]||!Ht(e[t])))}))}satisfy(e,t,n){return!this.constraint.allowWildcardForProperties&&!this.hasAllRequiredPropertiesSpecific(e)||this.constraint.satisfy(e,t,n)}}const Li=[{name:"noRepeatedChannel",description:"Each encoding channel should only be used once.",properties:[Mt.CHANNEL],allowWildcardForProperties:!0,strict:!0,satisfy:(e,t,n)=>{const r={};return tt(e.getEncodings(),(e=>!!Ht(e.channel)||!r[e.channel]&&(r[e.channel]=!0,!0)))}},{name:"alwaysIncludeZeroInScaleWithBarMark",description:"Do not recommend bar mark if scale does not start at zero",properties:[Mt.MARK,Mt.SCALE,Ot("scale","zero"),Mt.CHANNEL,Mt.TYPE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n)=>{const r=e.getMark(),i=e.getEncodings();if(r===Pt)for(const e of i)if(or(e)&&(e.channel===C||e.channel===O)&&e.type===Oe&&e.scale&&!1===e.scale.zero)return!1;return!0}},{name:"autoAddCount",description:"Automatically adding count only for plots with only ordinal, binned quantitative, or temporal with timeunit fields.",properties:[Mt.BIN,Mt.TIMEUNIT,Mt.TYPE,Mt.AUTOCOUNT],allowWildcardForProperties:!0,strict:!1,satisfy:(e,t,n)=>{if(rt(e.getEncodings(),(e=>cr(e))))return tt(e.getEncodings(),(e=>{if(ir(e))return!0;if(ar(e))return!0;switch(e.type){case Oe:return!!e.bin;case Se:return!!e.timeUnit;case Ae:case Nn.KEY:case Ne:return!0}throw new Error("Unsupported Type")}));if(tt(e.wildcardIndex.encodingIndicesByProperty.get("autoCount")||[],(t=>{const n=e.getEncodingQueryByIndex(t);return ar(n)&&!Ht(n.autoCount)})))return rt(e.getEncodings(),(e=>(or(e)||ar(e))&&e.type===Oe?!sr(e)&&(or(e)&&(!e.bin||Ht(e.bin))):!(!or(e)||e.type!==Se)&&(!e.timeUnit||Ht(e.timeUnit))));return!0}},{name:"channelPermittedByMarkType",description:"Each encoding channel should be supported by the mark type",properties:[Mt.CHANNEL,Mt.MARK],allowWildcardForProperties:!0,strict:!0,satisfy:(e,t,n)=>{const r=e.getMark();return!!Ht(r)||tt(e.getEncodings(),(e=>!!Ht(e.channel)||("row"===e.channel||"column"===e.channel||"facet"===e.channel||!!pe(e.channel,r))))}},{name:"hasAllRequiredChannelsForMark",description:"All required channels for the specified mark should be specified",properties:[Mt.CHANNEL,Mt.MARK],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n)=>{const r=e.getMark();switch(r){case Ut:case It:return e.channelUsed(C)&&e.channelUsed(O);case Rt:return e.channelUsed(Y);case Pt:case Lt:case Gt:case Bt:case jt:case $t:return e.channelUsed(C)||e.channelUsed(O);case Dt:return!e.wildcardIndex.hasProperty(Mt.CHANNEL)||e.channelUsed(C)||e.channelUsed(O)}throw new Error(`hasAllRequiredChannelsForMark not implemented for mark${JSON.stringify(r)}`)}},{name:"omitAggregate",description:"Omit aggregate plots.",properties:[Mt.AGGREGATE,Mt.AUTOCOUNT],allowWildcardForProperties:!0,strict:!1,satisfy:(e,t,n)=>!e.isAggregate()},{name:"omitAggregatePlotWithDimensionOnlyOnFacet",description:"Omit aggregate plots with dimensions only on facets as that leads to inefficient use of space.",properties:[Mt.CHANNEL,Mt.AGGREGATE,Mt.AUTOCOUNT],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n)=>{if(e.isAggregate()){let t=!1,r=!1,i=!1;if(e.specQuery.encodings.forEach(((n,o)=>{ir(n)||sr(n)||or(n)&&!n.aggregate&&(r=!0,et([T,w],n.channel)?e.wildcardIndex.hasEncodingProperty(o,Mt.CHANNEL)&&(i=!0):t=!0)})),r&&!t&&(i||n.constraintManuallySpecifiedValue))return!1}return!0}},{name:"omitAggregatePlotWithoutDimension",description:"Aggregate plots without dimension should be omitted",properties:[Mt.AGGREGATE,Mt.AUTOCOUNT,Mt.BIN,Mt.TIMEUNIT,Mt.TYPE],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n)=>!e.isAggregate()||rt(e.getEncodings(),(e=>!!(gr(e)||or(e)&&"temporal"===e.type)))},{name:"omitBarLineAreaWithOcclusion",description:"Don't use bar, line or area to visualize raw plot as they often lead to occlusion.",properties:[Mt.MARK,Mt.AGGREGATE,Mt.AUTOCOUNT],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n)=>!et([Pt,It,Ut],e.getMark())||e.isAggregate()},{name:"omitBarTickWithSize",description:"Do not map field to size channel with bar and tick mark",properties:[Mt.CHANNEL,Mt.MARK],allowWildcardForProperties:!0,strict:!1,satisfy:(e,t,n)=>{const r=e.getMark();if(et([Bt,Pt],r)&&e.channelEncodingField(B)){if(n.constraintManuallySpecifiedValue)return!1;{const t=e.specQuery.encodings;for(let n=0;n<t.length;n++){if(t[n].channel===B)return!e.wildcardIndex.hasEncodingProperty(n,Mt.CHANNEL)}}}return!0}},{name:"omitBarAreaForLogScale",description:"Do not use bar and area mark for x and y's log scale",properties:[Mt.MARK,Mt.CHANNEL,Mt.SCALE,Ot("scale","type"),Mt.TYPE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n)=>{const r=e.getMark(),i=e.getEncodings();if(r===Ut||r===Pt)for(const e of i)if(or(e)&&(e.channel===C||e.channel===O)&&e.scale){if(hr(e)===ke)return!1}return!0}},{name:"omitMultipleNonPositionalChannels",description:"Unless manually specified, do not use multiple non-positional encoding channel to avoid over-encoding.",properties:[Mt.CHANNEL],allowWildcardForProperties:!0,strict:!1,satisfy:(e,t,n)=>{const r=e.specQuery.encodings;let i=0,o=!1;for(let t=0;t<r.length;t++){const a=r[t];if(ir(a)||sr(a))continue;const s=a.channel;if(!Ht(s)&&Ri[`${s}`]&&(i+=1,e.wildcardIndex.hasEncodingProperty(t,Mt.CHANNEL)&&(o=!0),i>1&&(o||n.constraintManuallySpecifiedValue)))return!1}return!0}},{name:"omitNonPositionalOrFacetOverPositionalChannels",description:"Do not use non-positional channels unless all positional channels are used",properties:[Mt.CHANNEL],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n)=>{const r=e.specQuery.encodings;let i=!1,o=!1,a=!1,s=!1;for(let t=0;t<r.length;t++){const n=r[t];if(ir(n)||sr(n))continue;const c=n.channel;c===C?a=!0:c===O?s=!0:Ht(c)||(i=!0,e.wildcardIndex.hasEncodingProperty(t,Mt.CHANNEL)&&(o=!0))}return!(o||n.constraintManuallySpecifiedValue&&i)||a&&s}},{name:"omitRaw",description:"Omit raw plots.",properties:[Mt.AGGREGATE,Mt.AUTOCOUNT],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n)=>!!e.isAggregate()},{name:"omitRawContinuousFieldForAggregatePlot",description:"Aggregate plot should not use raw continuous field as group by values. (Quantitative should be binned. Temporal should have time unit.)",properties:[Mt.AGGREGATE,Mt.AUTOCOUNT,Mt.TIMEUNIT,Mt.BIN,Mt.TYPE],allowWildcardForProperties:!0,strict:!1,satisfy:(e,t,n)=>{if(e.isAggregate()){const t=e.specQuery.encodings;for(let r=0;r<t.length;r++){const i=t[r];if(!ir(i)&&!sr(i)){if(or(i)&&i.type===Se&&!i.timeUnit&&(e.wildcardIndex.hasEncodingProperty(r,Mt.TIMEUNIT)||n.constraintManuallySpecifiedValue))return!1;if(i.type===Oe&&or(i)&&!i.bin&&!i.aggregate){if(e.wildcardIndex.hasEncodingProperty(r,Mt.BIN)||e.wildcardIndex.hasEncodingProperty(r,Mt.AGGREGATE)||e.wildcardIndex.hasEncodingProperty(r,Mt.AUTOCOUNT))return!1;if(n.constraintManuallySpecifiedValue)return!1}}}}return!0}},{name:"omitRawDetail",description:"Do not use detail channel with raw plot.",properties:[Mt.CHANNEL,Mt.AGGREGATE,Mt.AUTOCOUNT],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n)=>!!e.isAggregate()||tt(e.specQuery.encodings,((t,r)=>!(!ir(t)&&!sr(t))||(t.channel!==V||!e.wildcardIndex.hasEncodingProperty(r,Mt.CHANNEL)&&!n.constraintManuallySpecifiedValue)))},{name:"omitRepeatedField",description:"Each field should be mapped to only one channel",properties:[Mt.FIELD],allowWildcardForProperties:!0,strict:!1,satisfy:(e,t,n)=>{const r={},i={},o=e.specQuery.encodings;for(let t=0;t<o.length;t++){const a=o[t];if(ir(a)||ar(a))continue;let s;if(a.field&&!Ht(a.field)&&(s=a.field),ar(a)&&!Ht(a.autoCount)&&(s="count_*"),s){if(e.wildcardIndex.hasEncodingProperty(t,Mt.FIELD)&&(i[s]=!0),r[s]&&(i[s]||n.constraintManuallySpecifiedValue))return!1;r[s]=!0}}return!0}},{name:"omitVerticalDotPlot",description:"Do not output vertical dot plot.",properties:[Mt.CHANNEL],allowWildcardForProperties:!0,strict:!1,satisfy:(e,t,n)=>{const r=e.getEncodings();return 1!==r.length||r[0].channel!==O}},{name:"hasAppropriateGraphicTypeForMark",description:"Has appropriate graphic type for mark",properties:[Mt.CHANNEL,Mt.MARK,Mt.TYPE,Mt.TIMEUNIT,Mt.BIN,Mt.AGGREGATE,Mt.AUTOCOUNT],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n)=>{const r=e.getMark();switch(r){case Ut:case It:if(e.isAggregate()){const t=e.getEncodingQueryByChannel(C),n=e.getEncodingQueryByChannel(O),r=pr(t),i=pr(n);return t&&n&&r!==i&&!(or(t)&&!r&&et(["nominal","key"],t.type))&&!(or(n)&&!i&&et(["nominal","key"],n.type))}return!0;case Rt:return!0;case Pt:case Bt:if(e.channelEncodingField(B))return!1;{const t=e.getEncodingQueryByChannel(C),n=e.getEncodingQueryByChannel(O);return pr(t)!==pr(n)}case $t:const t=e.getEncodingQueryByChannel(C),n=e.getEncodingQueryByChannel(O),r=gr(t),i=gr(n),o=e.getEncodingQueryByChannel(D),a=pr(o),s=!!or(o)&&o.type===Ae,c=r&&i||r&&!e.channelUsed(O)||i&&!e.channelUsed(C),u=!o||o&&(a||s);return c&&u;case Lt:case Dt:case Gt:case jt:return!0}throw new Error(`hasAllRequiredChannelsForMark not implemented for mark${r}`)}},{name:"omitInvalidStackSpec",description:"If stack is specified, must follow Vega-Lite stack rules",properties:[Mt.STACK,Mt.FIELD,Mt.CHANNEL,Mt.MARK,Mt.AGGREGATE,Mt.AUTOCOUNT,Mt.SCALE,Ot("scale","type"),Mt.TYPE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n)=>{if(!e.wildcardIndex.hasProperty(Mt.STACK))return!0;const r=e.getVlStack();return(null!==r||null===e.getStackOffset())&&r.fieldChannel===e.getStackChannel()}},{name:"omitNonSumStack",description:"Stack specifications that use non-summative aggregates should be omitted (even implicit ones)",properties:[Mt.CHANNEL,Mt.MARK,Mt.AGGREGATE,Mt.AUTOCOUNT,Mt.SCALE,Ot("scale","type"),Mt.TYPE],allowWildcardForProperties:!1,strict:!0,satisfy:(e,t,n)=>{const r=e.getVlStack();if(null!=r){const t=e.getEncodingQueryByChannel(r.fieldChannel);if(!et(cn,t.aggregate))return!1}return!0}},{name:"omitTableWithOcclusionIfAutoAddCount",description:"Plots without aggregation or autocount where x and y are both discrete should be omitted if autoAddCount is enabled as they often lead to occlusion",properties:[Mt.CHANNEL,Mt.TYPE,Mt.TIMEUNIT,Mt.BIN,Mt.AGGREGATE,Mt.AUTOCOUNT],allowWildcardForProperties:!1,strict:!1,satisfy:(e,t,n)=>{if(n.autoAddCount){const t=e.getEncodingQueryByChannel("x"),n=e.getEncodingQueryByChannel("y");if((!or(t)||gr(t))&&(!or(n)||gr(n)))return!!e.isAggregate()&&tt(e.getEncodings(),(e=>{const t=e.channel;return!(t!==C&&t!==O&&t!==T&&t!==w&&or(e)&&!e.aggregate)}))}return!0}}].map((e=>new Bi(e))),Gi=Li.reduce(((e,t)=>(e[t.name()]=t,e)),{}),zi=Li.reduce(((e,t)=>{for(const n of t.properties())e.set(n,e.get(n)||[]),e.get(n).push(t);return e}),new _n);function Wi(e,t,n,r,i){const o=zi.get(e)||[];for(const e of o)if(e.strict()||i[e.name()]){if(!e.satisfy(n,r,i)){const r=`(spec) ${e.name()}`;return i.verbose&&console.log(`${r} failed with ${n.toShorthand()} for ${t.name}`),r}}return null}var Hi=Object.freeze({__proto__:null,SpecConstraintModel:Bi,SPEC_CONSTRAINTS:Li,SPEC_CONSTRAINT_INDEX:Gi,checkSpec:Wi}),qi=Object.freeze({__proto__:null,encoding:ji,spec:Hi});const Yi=new _n;function Qi(e){return Yi.get(e)}function Vi(e){return(t,n,r)=>(i,o)=>{const a=t.encodingIndicesByProperty.get(e);return function s(c){if(c===a.length)return void i.push(o.duplicate());const u=a[c],l=t.encodings[u].get(e),d=o.getEncodingQueryByIndex(u),f=o.getEncodingProperty(u,e);ir(d)||sr(d)||!f?s(c+1):(l.enum.forEach((t=>{null===t&&(t=void 0),o.setEncodingProperty(u,e,t,l);if($i(e,l,u,o,n,r))return;Wi(e,l,o,n,r)||s(c+1)})),o.resetEncodingProperty(u,e,l))}(0),i}}Yi.set("mark",((e,t,n)=>(r,i)=>(i.getMark().enum.forEach((o=>{i.setMark(o);Wi("mark",e.mark,i,t,n)||r.push(i.duplicate())})),i.resetMark(),r))),ut.forEach((e=>{Yi.set(e,Vi(e))})),Et.forEach((e=>{Yi.set(e,Vi(e))}));var Ki=Object.freeze({__proto__:null,getEnumerator:Qi,EncodingPropertyGeneratorFactory:Vi});function Ji(e){return Ze.exports.isObject(e)&&!!e.property}function Xi(e,t,n){return t=t||new _n,n=n||new _n,e.forEach((e=>{Ji(e)?(t.setByKey(e.property,!0),n.setByKey(e.property,e.replace)):t.setByKey(e,!0)})),{include:t,replaceIndex:n,replacer:Hn(n)}}const Zi=[Mt.FIELD,Mt.TYPE,Mt.AGGREGATE,Mt.BIN,Mt.TIMEUNIT,Mt.STACK],eo=Zi.concat([{property:Mt.CHANNEL,replace:{x:"xy",y:"xy",color:"style",size:"style",shape:"style",opacity:"style",row:"facet",column:"facet"}}]);var to=Object.freeze({__proto__:null,REPLACE_BLANK_FIELDS:{"*":""},REPLACE_XY_CHANNELS:{x:"xy",y:"xy"},REPLACE_FACET_CHANNELS:{row:"facet",column:"facet"},REPLACE_MARK_STYLE_CHANNELS:{color:"style",opacity:"style",shape:"style",size:"style"},isExtendedGroupBy:Ji,parseGroupBy:Xi,toString:function(e){return Ze.exports.isArray(e)?e.map((e=>{if(Ji(e)){if(e.replace){const t=Ze.exports.keys(e.replace).reduce(((t,n)=>{const r=e.replace[n];return(t[r]=t[r]||[]).push(n),t}),{});return`${e.property}[`+Ze.exports.keys(t).map((e=>`${t[e].sort().join(",")}=>${e}`)).join(";")+"]"}return e.property}return e})).join(","):e},GROUP_BY_FIELD_TRANSFORM:Zi,GROUP_BY_ENCODING:eo});const no={};function ro(e,t){no[e]=t}const io="field",oo="fieldTransform",ao="encoding",so="spec";function co(e,t){if(t){const n={name:"",path:"",items:[]},r={},i=[],o=[],a=[];for(let e=0;e<t.length;e++){i.push(e>0?i[e-1].duplicate():new _n),o.push(e>0?o[e-1].duplicate():new _n);const n=t[e].groupBy;if(Ze.exports.isArray(n)){const t=Xi(n,i[e],o[e]);a.push(t.replacer)}}return e.forEach((e=>{let o="",s=n;for(let n=0;n<t.length;n++){const c=s.groupBy=t[n].groupBy;s.orderGroupBy=t[n].orderGroupBy;const u=Ze.exports.isArray(c)?Xn(e.specQuery,i[n],a[n]):no[c](e.specQuery);o+=`/${u}`,r[o]||(r[o]={name:u,path:o,items:[]},s.items.push(r[o])),s=r[o]}s.items.push(e)})),n}return{name:"",path:"",items:e}}const uo=Xi([Mt.FIELD]);function lo(e,t){return no[t](e)}ro(io,(e=>Xn(e,uo.include,uo.replacer)));const fo=Xi(Zi);ro(oo,(e=>Xn(e,fo.include,fo.replacer)));const po=Xi(eo);ro(ao,(e=>Xn(e,po.include,po.replacer))),ro(so,(e=>JSON.stringify(e)));var go=Object.freeze({__proto__:null,registerKeyFn:ro,FIELD:io,FIELD_TRANSFORM:oo,ENCODING:ao,SPEC:so,nest:co,getGroupByKey:lo,PARSED_GROUP_BY_FIELD_TRANSFORM:fo,PARSED_GROUP_BY_ENCODING:po});class ho{constructor(){this._mark=void 0,this._encodings={},this._encodingIndicesByProperty=new _n}setEncodingProperty(e,t,n){const r=this._encodings;(r[e]=r[e]||new _n).set(t,n);const i=this._encodingIndicesByProperty;return i.set(t,i.get(t)||[]),i.get(t).push(e),this}hasEncodingProperty(e,t){return!!this._encodings[e]&&this._encodings[e].has(t)}hasProperty(e){if(At(e))return this.encodingIndicesByProperty.has(e);if("mark"===e)return!!this.mark;throw new Error(`Unimplemented for property ${e}`)}isEmpty(){return!this.mark&&0===this.encodingIndicesByProperty.size()}setMark(e){return this._mark=e,this}get mark(){return this._mark}get encodings(){return this._encodings}get encodingIndicesByProperty(){return this._encodingIndicesByProperty}}class mo{constructor(e,t,n,r,i){this._rankingScore={},this._spec=e,this._channelFieldCount=e.encodings.reduce(((e,t)=>(Ht(t.channel)||ar(t)&&!1===t.autoCount||(e[`${t.channel}`]=1),e)),{}),this._wildcardIndex=t,this._assignedWildcardIndex=i,this._opt=r,this._schema=n}static build(e,t,n){const r=new ho;if(Ht(e.mark)){const t=Jt(Mt.MARK);e.mark=Qt(e.mark,t,n.enum.mark),r.setMark(e.mark)}if(e.encodings.forEach(((e,i)=>{ar(e)&&(console.warn("A field with autoCount should not be included as autoCount meant to be an internal object."),e.type=Oe),or(e)&&void 0===e.type&&(e.type=Wt),ut.forEach((o=>{if(Ht(e[o])){const a=Jt(o)+i,s=en(o,t,n),c=e[o]=Qt(e[o],a,s);r.setEncodingProperty(i,o,c)}})),Et.forEach((o=>{const a=e[o.parent];if(a){const e=o.child;if(Ht(a[e])){const s=Jt(o)+i,c=en(o,t,n),u=a[e]=Qt(a[e],s,c);r.setEncodingProperty(i,o,u)}}}))})),n.autoAddCount){const i={name:Jt(Mt.CHANNEL)+e.encodings.length,enum:en(Mt.CHANNEL,t,n)},o={name:Jt(Mt.AUTOCOUNT)+e.encodings.length,enum:[!1,!0]},a={channel:i,autoCount:o,type:Oe};e.encodings.push(a);const s=e.encodings.length-1;r.setEncodingProperty(s,Mt.CHANNEL,i),r.setEncodingProperty(s,Mt.AUTOCOUNT,o)}return new mo(e,r,t,n,{})}get wildcardIndex(){return this._wildcardIndex}get schema(){return this._schema}get specQuery(){return this._spec}duplicate(){return new mo(Ze.exports.duplicate(this._spec),this._wildcardIndex,this._schema,this._opt,Ze.exports.duplicate(this._assignedWildcardIndex))}setMark(e){const t=this._wildcardIndex.mark.name;this._assignedWildcardIndex[t]=this._spec.mark=e}resetMark(){const e=this._spec.mark=this._wildcardIndex.mark;delete this._assignedWildcardIndex[e.name]}getMark(){return this._spec.mark}getEncodingProperty(e,t){const n=this._spec.encodings[e];return st(t)?n[t.parent][t.child]:n[t]}setEncodingProperty(e,t,n,r){const i=this._spec.encodings[e];t===Mt.CHANNEL&&i.channel&&!Ht(i.channel)&&this._channelFieldCount[i.channel]--,st(t)?i[t.parent][t.child]=n:ft(t)&&!0===n?i[t]=Ze.exports.extend({},i[t],{enum:void 0,name:void 0}):i[t]=n,this._assignedWildcardIndex[r.name]=n,t===Mt.CHANNEL&&(this._channelFieldCount[n]=(this._channelFieldCount[n]||0)+1)}resetEncodingProperty(e,t,n){const r=this._spec.encodings[e];t===Mt.CHANNEL&&this._channelFieldCount[r.channel]--,st(t)?r[t.parent][t.child]=n:r[t]=n,delete this._assignedWildcardIndex[n.name]}channelUsed(e){return this._channelFieldCount[e]>0}channelEncodingField(e){return or(this.getEncodingQueryByChannel(e))}getEncodings(){return this._spec.encodings.filter((e=>!sr(e)))}getEncodingQueryByChannel(e){for(const t of this._spec.encodings)if(t.channel===e)return t}getEncodingQueryByIndex(e){return this._spec.encodings[e]}isAggregate(){return jn(this._spec)}getVlStack(){return Rn(this._spec)}getStackOffset(){return Bn(this._spec)}getStackChannel(){return Ln(this._spec)}toShorthand(e){if(e){if(Ze.exports.isString(e))return lo(this.specQuery,e);const t=Xi(e);return Xn(this._spec,t.include,t.replacer)}return Xn(this._spec)}toSpec(e){if(Ht(this._spec.mark))return null;const t={};return(e=e||this._spec.data)&&(t.data=e),this._spec.transform&&(t.transform=this._spec.transform),t.mark=this._spec.mark,t.encoding=lr(this.specQuery.encodings,{schema:this._schema,wildcardMode:"null"}),this._spec.width&&(t.width=this._spec.width),this._spec.height&&(t.height=this._spec.height),this._spec.background&&(t.background=this._spec.background),this._spec.padding&&(t.padding=this._spec.padding),this._spec.title&&(t.title=this._spec.title),null===t.encoding?null:((this._spec.config||this._opt.defaultSpecConfig)&&(t.config=Ze.exports.extend({},this._opt.defaultSpecConfig,this._spec.config)),t)}getRankingScore(e){return this._rankingScore[e]}setRankingScore(e,t){this._rankingScore[e]=t}}var yo=Object.freeze({__proto__:null,SpecQueryModel:mo}),vo=Object.freeze({__proto__:null});function bo(e){if(e.groupBy){const t={groupBy:e.groupBy};e.orderBy&&(t.orderGroupBy=e.orderBy);const n={spec:Ze.exports.duplicate(e.spec),nest:[t]};return e.chooseBy&&(n.chooseBy=e.chooseBy),e.config&&(n.config=e.config),n}return Ze.exports.duplicate(e)}var Eo=Object.freeze({__proto__:null,encoding:mr,groupBy:to,shorthand:rr,spec:Wn,transform:vo,normalize:bo});function To(e){return void 0!==e.items}function wo(e){let t=e.items[0];for(;t&&To(t);)t=t.items[0];return t}var xo,Co=Object.freeze({__proto__:null,isResultTree:To,getTopResultTreeItem:wo,mapLeaves:function e(t,n){return Object.assign(Object.assign({},t),{items:t.items.map((t=>To(t)?e(t,n):n(t)))})}});class Oo{constructor(e){this.type=e,this.scoreIndex=this.initScore()}getFeatureScore(e){const t=this.type,n=this.scoreIndex[e];if(void 0!==n)return{type:t,feature:e,score:n}}}!function(e){e[e.Q=Oe]="Q",e[e.BIN_Q=`bin_${Oe}`]="BIN_Q",e[e.T=Se]="T",e[e.TIMEUNIT_T="timeUnit_time"]="TIMEUNIT_T",e[e.TIMEUNIT_O=`timeUnit_${Ae}`]="TIMEUNIT_O",e[e.O=Ae]="O",e[e.N=Ne]="N",e[e.K=Nn.KEY]="K",e[e.NONE="-"]="NONE"}(xo||(xo={}));const Ao=xo.Q,So=xo.BIN_Q,No=xo.T,Mo=xo.TIMEUNIT_T,_o=xo.TIMEUNIT_O,Fo=xo.O,ko=xo.N,Uo=xo.K,Po=xo.NONE;function Io(e){if(e.bin)return xo.BIN_Q;if(e.timeUnit){return qe(hr(e))?xo.TIMEUNIT_O:xo.TIMEUNIT_T}return e.type}const Do=-10;function $o(e,t,n,r){return`${e}_${t}_${n}_${r}`}const jo=[new class extends Oo{constructor(){super("Axis")}initScore(e={}){e=Object.assign(Object.assign({},nn),e);const t={};return[{feature:So,opt:"preferredBinAxis"},{feature:No,opt:"preferredTemporalAxis"},{feature:Mo,opt:"preferredTemporalAxis"},{feature:_o,opt:"preferredTemporalAxis"},{feature:Fo,opt:"preferredOrdinalAxis"},{feature:ko,opt:"preferredNominalAxis"}].forEach((n=>{e[n.opt]===C?t[`${n.feature}_${O}`]=-.01:e[n.opt]===O&&(t[`${n.feature}_${C}`]=-.01)})),t}featurize(e,t){return`${e}_${t}`}getScore(e,t,n){return e.getEncodings().reduce(((e,t)=>{if(or(t)||ar(t)){const n=Io(t),r=this.featurize(n,t.channel),i=this.getFeatureScore(r);i&&e.push(i)}return e}),[])}},new class extends Oo{constructor(){super("Dimension")}initScore(){return{row:-2,column:-2,color:0,opacity:0,size:0,shape:0}}getScore(e,t,n){return e.isAggregate()&&e.getEncodings().reduce(((e,t)=>{if(ar(t)||or(t)&&!t.aggregate){const n=this.getFeatureScore(`${t.channel}`);if(n&&n.score>e.score)return n}return e}),{type:"Dimension",feature:"No Dimension",score:-5}),[]}},new class extends Oo{constructor(){super("Facet")}initScore(e){const t={};return(e=Object.assign(Object.assign({},nn),e)).preferredFacet===T?t[w]=-.01:e.preferredFacet===w&&(t[T]=-.01),t}getScore(e,t,n){return e.getEncodings().reduce(((e,t)=>{if(or(t)||ar(t)){const n=this.getFeatureScore(t.channel);n&&e.push(n)}return e}),[])}},new class extends Oo{constructor(){super("Mark")}initScore(){return function(){const e=[Ao,No],t=[So,_o,Fo,ko,Uo].concat([Po]),n={};e.forEach((t=>{e.forEach((e=>{nt({point:0,text:-.2,tick:-.5,rect:-1,bar:-2,line:-2,area:-2,rule:-2.5},((r,i)=>{const o=$o(t,e,!0,i);n[o]=r}));nt({point:0,text:-.2,tick:-.5,bar:-2,line:-2,area:-2,rule:-2.5},((r,i)=>{const o=$o(t,e,!1,i);n[o]=r}))}))})),e.forEach((e=>{t.forEach((t=>{nt({tick:0,point:-.2,text:-.5,bar:-2,line:-2,area:-2,rule:-2.5},((r,i)=>{const o=$o(e,t,!0,i);n[o]=r;const a=$o(t,e,!0,i);n[a]=r}))})),[Mo].forEach((t=>{nt({point:0,text:-.5,tick:-1,bar:-2,line:-2,area:-2,rule:-2.5},((r,i)=>{const o=$o(e,t,!0,i);n[o]=r;const a=$o(t,e,!0,i);n[a]=r}))})),[Po,ko,Fo,Uo].forEach((t=>{nt({bar:0,point:-.2,tick:-.25,text:-.3,line:-2,area:-2,rule:-2.5},((r,i)=>{const o=$o(e,t,!1,i);n[o]=r;const a=$o(t,e,!1,i);n[a]=r}))})),[So].forEach((t=>{nt({bar:0,point:-.2,tick:-.25,text:-.3,line:-.5,area:-.5,rule:-2.5},((r,i)=>{const o=$o(e,t,!1,i);n[o]=r;const a=$o(t,e,!1,i);n[a]=r}))})),[Mo,_o].forEach((t=>{nt({line:0,area:-.1,bar:-.2,point:-.3,tick:-.35,text:-.4,rule:-2.5},((r,i)=>{const o=$o(e,t,!1,i);n[o]=r;const a=$o(t,e,!1,i);n[a]=r}))}))})),[Mo].forEach((e=>{[Mo].forEach((t=>{const r={point:0,rect:-.1,text:-.5,tick:-1,bar:-2,line:-2,area:-2,rule:-2.5};nt(r,((r,i)=>{const o=$o(e,t,!0,i);n[o]=r})),nt(r,((r,i)=>{const o=$o(e,t,!1,i);n[o]=r}))})),t.forEach((t=>{const r={tick:0,point:-.2,text:-.5,rect:-1,bar:-2,line:-2,area:-2,rule:-2.5};nt(r,((r,i)=>{const o=$o(e,t,!0,i);n[o]=r})),nt(r,((r,i)=>{const o=$o(t,e,!0,i);n[o]=r})),nt(r,((r,i)=>{const o=$o(e,t,!1,i);n[o]=r})),nt(r,((r,i)=>{const o=$o(t,e,!1,i);n[o]=r}))}))}));for(const e of t)for(const r of t){const t={point:0,rect:0,text:-.1,tick:-1,bar:-2,line:-2,area:-2,rule:-2.5};nt(t,((t,i)=>{const o=$o(e,r,!0,i);n[o]=t})),nt(t,((t,i)=>{const o=$o(e,r,!1,i);n[o]=t}))}return n}()}getScore(e,t,n){let r=e.getMark();r!==Lt&&r!==Gt||(r=Dt);const i=e.getEncodingQueryByChannel(C),o=i?Io(i):Po,a=e.getEncodingQueryByChannel(O),s=`${o}_${a?Io(a):Po}_${!e.isAggregate()}_${r}`,c=this.getFeatureScore(s);return c?[c]:(console.error("feature score missing for",s),[])}},new class extends Oo{constructor(){super("SizeChannel")}initScore(){return{bar_size:-2,tick_size:-2}}getScore(e,t,n){const r=e.getMark();return e.getEncodings().reduce(((e,t)=>{if(or(t)||ar(t)){const n=`${r}_${t.channel}`,i=this.getFeatureScore(n);i&&e.push(i)}return e}),[])}},new class extends Oo{constructor(){super("TypeChannel")}initScore(){const e={},t={x:0,y:0,size:-.575,color:-.725,text:-2,opacity:-3,shape:Do,row:Do,column:Do,detail:-20};[Ao,No,Mo].forEach((n=>{Ze.exports.keys(t).forEach((r=>{e[this.featurize(n,r)]=t[r]}))}));const n=Ze.exports.extend({},t,{row:-.75,column:-.75,shape:-3.1,text:-3.2,detail:-4});[So,_o,Fo].forEach((t=>{Ze.exports.keys(n).forEach((r=>{e[this.featurize(t,r)]=n[r]}))}));const r={x:0,y:0,color:-.6,shape:-.65,row:-.7,column:-.7,text:-.8,detail:-2,size:-3,opacity:-3.1};return Ze.exports.keys(r).forEach((t=>{e[this.featurize(ko,t)]=r[t],e[this.featurize(Uo,t)]=et(["x","y","detail"],t)?-1:r[t]-2})),e}featurize(e,t){return`${e}_${t}`}getScore(e,t,n){const r=e.getEncodings().reduce(((e,t)=>{if(or(t)||ar(t)){const n=er(t);(e[n]=e[n]||[]).push(t)}return e}),{}),i=[];return nt(r,(e=>{const t=e.reduce(((e,t)=>{if(or(t)||ar(t)){const n=Io(t),r=this.featurize(n,t.channel),i=this.getFeatureScore(r);if(null===e||i.score>e.score)return i}return e}),null);i.push(t)})),i}}];function Ro(e,t,n){const r=jo.reduce(((r,i)=>{const o=i.getScore(e,t,n);return r.concat(o)}),[]);return{score:r.reduce(((e,t)=>e+t.score),0),features:r}}const Bo="aggregationQuality";function Lo(e,t,n){const r=function(e,t,n){const r=e.getEncodings();if(e.isAggregate()){if(rt(r,(e=>or(e)&&(e.type===Oe&&!e.bin&&!e.aggregate||e.type===Se&&!e.timeUnit))))return{type:Bo,score:.1,feature:"Aggregate with raw continuous"};if(rt(r,(e=>or(e)&&gr(e)))){const e=rt(r,(e=>or(e)&&"count"===e.aggregate||cr(e))),t=rt(r,(e=>or(e)&&!!e.bin));return e?{type:Bo,score:.8,feature:"Aggregate with count"}:t?{type:Bo,score:.7,feature:"Aggregate with bin but without count"}:{type:Bo,score:.9,feature:"Aggregate without count and without bin"}}return{type:Bo,score:.3,feature:"Aggregate without dimension"}}return rt(r,(e=>or(e)&&!gr(e)))?{type:Bo,score:1,feature:"Raw with measure"}:{type:Bo,score:.2,feature:"Raw without measure"}}(e);return{score:r.score,features:[r]}}var Go=Object.freeze({__proto__:null,name:Bo,score:Lo});const zo="fieldOrder";function Wo(e,t,n){const r=e.wildcardIndex.encodingIndicesByProperty.get("field");if(!r)return{score:0,features:[]};const i=e.specQuery.encodings,o=t.fieldSchemas.length,a=[];let s=0,c=1;for(let n=r.length-1;n>=0;n--){const u=r[n],l=i[u];let d;if(!or(l))continue;d=l.field;const f=e.wildcardIndex.encodings[u].get("field"),p=t.fieldSchema(d).index,g=-p*c;s+=g,a.push({score:g,type:"fieldOrder",feature:`field ${f.name} is ${d} (#${p} in the schema)`}),c*=o}return{score:s,features:a}}var Ho=Object.freeze({__proto__:null,name:zo,score:Wo});const qo={};function Yo(e,t){qo[e]=t}function Qo(e){return qo[e]}function Vo(e,t,n,r){return t.nest&&r!==t.nest.length?(e.items.forEach((e=>{Vo(e,t,n,r+1)})),t.nest[r].orderGroupBy&&e.items.sort(Jo(t.nest[r].orderGroupBy,n,t.config))):(t.orderBy||t.chooseBy)&&(e.items.sort(Ko(t.orderBy||t.chooseBy,n,t.config)),t.chooseBy&&e.items.length>0&&e.items.splice(1)),e}function Ko(e,t,n){return(r,i)=>Xo(e instanceof Array?e:[e],r,i,t,n)}function Jo(e,t,n){return(r,i)=>{const o=wo(r),a=wo(i);return Xo(e instanceof Array?e:[e],o,a,t,n)}}function Xo(e,t,n,r,i){for(const o of e){const e=Zo(n,o,r,i).score-Zo(t,o,r,i).score;if(0!==e)return e}return 0}function Zo(e,t,n,r){if(void 0!==e.getRankingScore(t))return e.getRankingScore(t);const i=Qo(t)(e,n,r);return e.setRankingScore(t,i),i}const ea="effectiveness";Yo(ea,Ro),Yo(Bo,Lo),Yo(zo,Wo);var ta=Object.freeze({__proto__:null,aggregation:Go,fieldOrder:Ho,register:Yo,get:Qo,rank:Vo,comparatorFactory:Ko,groupComparatorFactory:Jo,getScore:Zo,EFFECTIVENESS:ea,effectiveness:Ro});function na(e,t,n){const r={};return e=e.map((function(e){return n.smallRangeStepForHighCardinalityOrFacet&&(e=function(e,t,n,r){[T,O,w,C].forEach((t=>{n[t]=e.getEncodingQueryByChannel(t)}));const i=n[O];if(void 0!==i&&or(i)&&(n[T]||t.cardinality(i)>r.smallRangeStepForHighCardinalityOrFacet.maxCardinality)){void 0===i.scale&&(i.scale={});const t=hr(i);i.scale&&(void 0===t||qe(t))&&(e.specQuery.height||(e.specQuery.height={step:12}))}const o=n[C];if(or(o)&&(n[w]||t.cardinality(o)>r.smallRangeStepForHighCardinalityOrFacet.maxCardinality)){void 0===o.scale&&(o.scale={});const t=hr(o);o.scale&&(void 0===t||qe(t))&&(e.specQuery.width||(e.specQuery.width={step:12}))}return e}(e,t,r,n)),n.nominalColorScaleForHighCardinality&&(e=function(e,t,n,r){n.color=e.getEncodingQueryByChannel(D);const i=n.color;or(i)&&void 0!==i&&(i.type===Ne||i.type===Nn.KEY)&&t.cardinality(i)>r.nominalColorScaleForHighCardinality.maxCardinality&&(void 0===i.scale&&(i.scale={}),i.scale&&(i.scale.range||(i.scale.scheme=r.nominalColorScaleForHighCardinality.palette)));return e}(e,t,r,n)),n.xAxisOnTopForHighYCardinalityWithoutColumn&&(e=function(e,t,n,r){if([w,C,O].forEach((t=>{n[t]=e.getEncodingQueryByChannel(t)})),void 0===n[w]){const e=n[C],i=n[O];or(e)&&or(i)&&void 0!==i&&i.field&&qe(hr(i))&&void 0!==e&&t.cardinality(i)>r.xAxisOnTopForHighYCardinalityWithoutColumn.maxCardinality&&(void 0===e.axis&&(e.axis={}),e.axis&&!e.axis.orient&&(e.axis.orient="top"))}return e}(e,t,r,n)),e}))}function ra(e,t,n=nn){const r=mo.build(e,t,n),i=r.wildcardIndex;let o=[r];return n.propertyPrecedence.forEach((e=>{const r=xt(e);if(i.hasProperty(r)){const e=Qi(r)(i,t,n);o=o.reduce(e,[])}})),!n.stylize||null===n.nominalColorScaleForHighCardinality&&null===n.smallRangeStepForHighCardinalityOrFacet&&null===n.xAxisOnTopForHighYCardinalityWithoutColumn?o:na(o,t,n)}e.config=an,e.constraint=qi,e.enumerate=Ki,e.generate=ra,e.model=yo,e.nest=go,e.property=_t,e.query=Eo,e.ranking=ta,e.recommend=function(e,t,n){return{query:e=Object.assign(Object.assign({},bo(e)),{config:Object.assign(Object.assign(Object.assign({},nn),n),e.config)}),result:Vo(co(ra(e.spec,t,e.config),e.nest),e,t,0)}},e.result=Co,e.schema=_i,e.util=at,e.version="0.21.2",e.wildcard=tn,Object.defineProperty(e,"__esModule",{value:!0})}));